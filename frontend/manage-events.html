<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Events</title>

  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<script>
  const token = localStorage.getItem("token");
  const user = JSON.parse(localStorage.getItem("user"));
  if (!token || !user) {
    window.location.href = "index.html";
  }
  if (user.role !== "President") {
    alert("Access denied");
    window.location.href = "index.html";
  }
  document.addEventListener("DOMContentLoaded", () => {
    document.body.style.overflow = "auto";
  });
</script>

<div class="theme-toggle" id="themeToggle">
  <i class="fas fa-moon"></i>
</div>

<div class="bg-animation">
  <div class="floating-shapes">
    <span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span>
  </div>
</div>

<div class="login-container">
  <div class="login-box">

    <div class="login-left" style="flex:0 0 25%;max-width:25%">
      <div class="brand-content">
        <div class="logo-icon">
          <i class="fas fa-layer-group"></i>
        </div>
        <h1>Manage Events</h1>
        <p>View all events</p>

        <div class="features-list">
          <div class="feature-item"><i class="fas fa-list"></i><span>All Events</span></div>
          <div class="feature-item"><i class="fas fa-layer-group"></i><span>Sub-events</span></div>
          <div class="feature-item"><i class="fas fa-eye"></i><span>View Only</span></div>
        </div>
      </div>
    </div>

    <div class="login-right" style="flex:0 0 75%;max-width:75%">
      <div class="login-form-container" style="max-width:100%">

        <div class="form-header">
          <h2>Manage Events</h2>
          <p>Existing events with their sub-events</p>
        </div>

        <div style="display:flex;gap:15px;margin-bottom:20px">
          <a href="dashboard/president.html" class="login-btn" style="text-decoration:none">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Dashboard</span>
          </a>
        </div>

        <div id="eventsList" style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:25px">
          <div class="input-group">
            <input disabled value="Loading events...">
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script src="js/main.js"></script>
<script>
  const eventsListEl = document.getElementById("eventsList");
  const API_ORIGIN = window.location.origin;
  const EVENT_STATUSES = ["Upcoming", "Ongoing", "Completed"];

  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    const text = await res.text();
    let data = null;
    try {
      data = text ? JSON.parse(text) : null;
    } catch (err) {
      data = null;
    }
    if (!res.ok) {
      const message = data && data.message ? data.message : `Request failed (${res.status})`;
      throw new Error(message);
    }
    return data;
  }

  function getToken() {
    return localStorage.getItem("token");
  }

  function getAuthHeaders(useJson = false) {
    const value = getToken();
    const headers = {};
    if (useJson) headers["Content-Type"] = "application/json";
    if (value) headers["Authorization"] = `Bearer ${value}`;
    return headers;
  }

  function escapeHtml(value) {
    return String(value ?? "").replace(/[&<>"']/g, (ch) => {
      const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" };
      return map[ch] || ch;
    });
  }

  function toDateInputValue(value) {
    const input = String(value || "").trim();
    if (!input) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(input)) return input;
    const parsed = new Date(input);
    if (Number.isNaN(parsed.getTime())) return "";
    return parsed.toISOString().slice(0, 10);
  }

  function renderEmpty(message) {
    eventsListEl.innerHTML = `
      <div class="input-group">
        <input disabled value="${message}">
      </div>
    `;
  }

  function buildSubEventCard(se) {
    const card = document.createElement("div");
    card.style.border = "1px solid var(--border-color)";
    card.style.borderRadius = "12px";
    card.style.padding = "12px";
    card.style.background = "var(--bg-secondary)";
    card.style.color = "var(--text-primary)";
    card.innerHTML = `
      <div style="font-weight:600;margin-bottom:6px;color:var(--text-primary)">${escapeHtml(se.name)}</div>
      <div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:8px">${escapeHtml(se.time || "")} â€¢ ${escapeHtml(se.venue || "")}</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;color:var(--text-muted);font-size:0.8rem">
        <span>Coords: ${se.coordinatorLimit || 0}</span>
        <span>Volunteers: ${se.volunteerLimit || 0}</span>
        <span>Fee: ${se.fee || 0}</span>
      </div>
    `;
    return card;
  }

  function openEditEventModal(evt) {
    return new Promise((resolve) => {
      const backdrop = document.createElement("div");
      backdrop.className = "modal-backdrop";
      const status = EVENT_STATUSES.includes(evt.status) ? evt.status : "Upcoming";
      backdrop.innerHTML = `
        <div class="modal-card" role="dialog" aria-modal="true" style="width:min(94vw,560px);text-transform:none">
          <div class="modal-title">Edit Event</div>
          <div class="modal-message">Update details for <strong>${escapeHtml(evt.name)}</strong>.</div>
          <form id="editEventForm" style="display:grid;gap:12px">
            <input class="modal-input" id="editEventName" placeholder="Event name" value="${escapeHtml(evt.name || "")}" required />
            <input class="modal-input" id="editEventDate" type="date" value="${escapeHtml(toDateInputValue(evt.date))}" />
            <input class="modal-input" id="editEventDescription" placeholder="Description / Venue" value="${escapeHtml(evt.description || "")}" />
            <select class="modal-input" id="editEventStatus">
              ${EVENT_STATUSES.map((item) => `<option value="${item}" ${item === status ? "selected" : ""}>${item}</option>`).join("")}
            </select>
            <div class="modal-actions">
              <button class="login-btn" data-action="cancel" type="button">Cancel</button>
              <button class="login-btn" data-action="save" type="submit">Save Changes</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(backdrop);

      const form = backdrop.querySelector("#editEventForm");
      const nameInput = backdrop.querySelector("#editEventName");
      const dateInput = backdrop.querySelector("#editEventDate");
      const descInput = backdrop.querySelector("#editEventDescription");
      const statusInput = backdrop.querySelector("#editEventStatus");
      const cancelBtn = backdrop.querySelector('[data-action="cancel"]');
      const handleEscape = (e) => {
        if (e.key === "Escape") cleanup(null);
      };
      let settled = false;

      const cleanup = (result) => {
        if (settled) return;
        settled = true;
        document.removeEventListener("keydown", handleEscape);
        backdrop.remove();
        resolve(result);
      };

      cancelBtn.addEventListener("click", () => cleanup(null));
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) cleanup(null);
      });
      document.addEventListener("keydown", handleEscape);

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = nameInput.value.trim();
        if (!name) {
          alert("Event name is required");
          nameInput.focus();
          return;
        }
        cleanup({
          name,
          date: dateInput.value.trim(),
          description: descInput.value.trim(),
          status: statusInput.value
        });
      });

      setTimeout(() => nameInput.focus(), 0);
    });
  }

  async function updateEvent(evt) {
    const tokenValue = getToken();
    if (!tokenValue) {
      alert("Login required");
      return;
    }

    const payload = await openEditEventModal(evt);
    if (!payload) return;

    try {
      const data = await fetchJSON(`${API_ORIGIN}/api/events/${evt.id}`, {
        method: "PUT",
        headers: getAuthHeaders(true),
        body: JSON.stringify(payload)
      });
      if (!data || data.success !== true) {
        alert((data && data.message) || "Unable to update event");
        return;
      }
      alert("Event updated successfully");
      await loadEvents();
    } catch (err) {
      console.error(err);
      alert(`Update failed: ${err.message || "Unknown error"}`);
    }
  }

  async function deleteEvent(evt) {
    const tokenValue = getToken();
    if (!tokenValue) {
      alert("Login required");
      return;
    }

    const message = `Delete event "${evt.name}"?\n\nThis will also delete all sub-events, registrations, and role assignments under it.`;
    let confirmed = false;
    if (window.uiConfirm) {
      confirmed = await window.uiConfirm({ title: "Delete Event", message });
    } else {
      confirmed = window.confirm(message);
    }
    if (!confirmed) return;

    try {
      const data = await fetchJSON(`${API_ORIGIN}/api/events/${evt.id}`, {
        method: "DELETE",
        headers: getAuthHeaders(false)
      });
      if (!data || data.success !== true) {
        alert((data && data.message) || "Unable to delete event");
        return;
      }
      alert("Event deleted successfully");
      await loadEvents();
    } catch (err) {
      console.error(err);
      alert(`Delete failed: ${err.message || "Unknown error"}`);
    }
  }

  async function toggleSubEvents(eventId, container, button) {
    if (container.dataset.loaded === "true") {
      const isHidden = container.style.display === "none";
      container.style.display = isHidden ? "grid" : "none";
      button.querySelector("span").textContent = isHidden ? "Hide Sub-events" : "View Sub-events";
      return;
    }

    container.innerHTML = "";
    try {
      const list = await fetchJSON(`${API_ORIGIN}/api/subevents/${eventId}`);
      if (!Array.isArray(list) || list.length === 0) {
        const empty = document.createElement("div");
        empty.className = "input-group";
        empty.innerHTML = `<input disabled value="No sub-events for this event">`;
        container.appendChild(empty);
      } else {
        list.forEach(se => container.appendChild(buildSubEventCard(se)));
      }
      container.dataset.loaded = "true";
      container.style.display = "grid";
      button.querySelector("span").textContent = "Hide Sub-events";
    } catch (err) {
      console.error(err);
      const errCard = document.createElement("div");
      errCard.className = "input-group";
      errCard.innerHTML = `<input disabled value="Unable to load sub-events">`;
      container.appendChild(errCard);
      container.dataset.loaded = "true";
      container.style.display = "grid";
    }
  }

  async function loadEvents() {
    try {
      if (eventsListEl) {
        eventsListEl.innerHTML = `
          <div class="input-group">
            <input disabled value="Fetching events...">
          </div>
        `;
      }
      const events = await fetchJSON(`${API_ORIGIN}/api/events`);
      if (!Array.isArray(events) || events.length === 0) {
        renderEmpty("No events created yet");
        return;
      }

      events.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

      eventsListEl.innerHTML = "";
      events.forEach(evt => {
        const eventName = escapeHtml(evt.name || "");
        const eventDate = escapeHtml(evt.date || "No date");
        const eventDescription = escapeHtml(evt.description || "No description");
        const eventStatus = escapeHtml(evt.status || "Upcoming");
        const approval = escapeHtml(evt.approvalStatus || "Draft");

        const card = document.createElement("div");
        card.style.border = "2px solid var(--border-color)";
        card.style.borderRadius = "16px";
        card.style.padding = "16px";
        card.style.background = "var(--input-bg)";
        card.style.boxShadow = "0 8px 20px rgba(0,0,0,0.06)";

        const subContainerId = `sub-${evt.id}`;
        card.style.color = "var(--text-primary)";
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px">
            <div style="font-weight:600;color:var(--text-primary)">${eventName}</div>
            <div style="font-size:0.75rem;color:var(--text-muted)">ID: ${evt.id}</div>
          </div>
          <div style="color:var(--text-muted);font-size:0.9rem;margin-bottom:8px">${eventDate}</div>
          <div style="color:var(--text-secondary);font-size:0.85rem;line-height:1.3;margin-bottom:10px">${eventDescription}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;color:var(--text-muted);font-size:0.78rem">
            <span style="border:1px solid var(--border-color);padding:4px 8px;border-radius:999px">Status: ${eventStatus}</span>
            <span style="border:1px solid var(--border-color);padding:4px 8px;border-radius:999px">Approval: ${approval}</span>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
            <button class="login-btn" data-action="toggle-subevents" data-event-id="${evt.id}" data-target="${subContainerId}">
              <i class="fas fa-layer-group"></i>
              <span>View Sub-events</span>
            </button>
            <button class="login-btn" data-action="edit-event" data-event-id="${evt.id}" style="background:linear-gradient(135deg,#5f9df7,#4c6fff)">
              <i class="fas fa-pen-to-square"></i>
              <span>Edit Event</span>
            </button>
            <button class="login-btn" data-action="delete-event" data-event-id="${evt.id}" style="background:linear-gradient(135deg,#fc8181,#f56565)">
              <i class="fas fa-trash"></i>
              <span>Delete Event</span>
            </button>
          </div>
          <div id="${subContainerId}" style="display:none;grid-template-columns:repeat(2,1fr);gap:12px;max-height:260px;overflow:auto;padding-right:6px"></div>
        `;

        eventsListEl.appendChild(card);

        const toggleBtn = card.querySelector('button[data-action="toggle-subevents"]');
        const editBtn = card.querySelector('button[data-action="edit-event"]');
        const deleteBtn = card.querySelector('button[data-action="delete-event"]');

        if (toggleBtn) {
          toggleBtn.addEventListener("click", async () => {
            const eventId = toggleBtn.getAttribute("data-event-id");
            const targetId = toggleBtn.getAttribute("data-target");
            const container = document.getElementById(targetId);
            if (!container) return;
            await toggleSubEvents(eventId, container, toggleBtn);
          });
        }

        if (editBtn) {
          editBtn.addEventListener("click", async () => {
            await updateEvent(evt);
          });
        }

        if (deleteBtn) {
          deleteBtn.addEventListener("click", async () => {
            await deleteEvent(evt);
          });
        }
      });
    } catch (err) {
      console.error(err);
      renderEmpty(`Error loading events: ${err.message || "Unknown error"}`);
    }
  }

  // kick off immediately + on load (in case DOM events already fired)
  try { loadEvents(); } catch (e) {}
  document.addEventListener("DOMContentLoaded", loadEvents);
  window.addEventListener("load", loadEvents);
  setTimeout(loadEvents, 600);
</script>
</body>
</html>
