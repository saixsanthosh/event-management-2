<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>President Dashboard</title>

  <!-- MAIN CSS -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- GOOGLE FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- FONT AWESOME -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<script>
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user"));

if (!token || !user) {
  window.location.href = "../index.html";
}

if (user.role !== "President") {
  alert("Access denied");
  window.location.href = "../index.html";
}
</script>

<!-- THEME TOGGLE -->
<div class="theme-toggle" id="themeToggle">
  <i class="fas fa-moon"></i>
</div>

<!-- BACKGROUND -->
<div class="bg-animation">
  <div class="floating-shapes">
    <span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span>
  </div>
</div>

<!-- MAIN CONTAINER -->
<div class="login-container">
  <div class="login-box">

    <!-- LEFT PANEL -->
    <div class="login-left" style="flex:0 0 25%;max-width:25%">
      <div class="brand-content">
        <div class="logo-icon">
          <i class="fas fa-user-shield"></i>
        </div>

        <h1>President Panel</h1>
        <p>Event Control Center</p>

        <div class="features-list">
          <div class="feature-item"><i class="fas fa-calendar-plus"></i><span>Create Event</span></div>
          <div class="feature-item"><i class="fas fa-layer-group"></i><span>Sub Events</span></div>
          <div class="feature-item"><i class="fas fa-users"></i><span>Hire Coordinator</span></div>
          <div class="feature-item"><i class="fas fa-qrcode"></i><span>Payment Control</span></div>
          <div class="feature-item"><i class="fas fa-paper-plane"></i><span>Approval Flow</span></div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="login-right" style="flex:0 0 75%;max-width:75%">
      <div class="login-form-container" style="max-width:100%">

        <!-- EVENT MANAGEMENT -->
        <div class="form-header">
          <h2>Event Management</h2>
          <p>Create and manage events</p>
        </div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:30px">
          
          <!-- CREATE EVENT -->
          <a href="../event.html" class="login-btn" style="text-decoration:none">
            <i class="fas fa-calendar-plus"></i>
            <span>Create Event</span>
          </a>

          <!-- MANAGE SUB EVENTS -->
          <a href="../manage-events.html" class="login-btn" style="text-decoration:none">
            <i class="fas fa-layer-group"></i>
            <span>Manage Events</span>
          </a>

        </div>

        <!-- HIRE COORDINATOR -->
        <div class="form-header">
          <h2>Hire Coordinator</h2>
          <p>Public registration link</p>
        </div>

        <div style="border:2px dashed var(--border-color);border-radius:16px;padding:20px;margin-bottom:30px">
          <div class="input-group">
            <input id="coordLink" value="apply-coordinator.html" readonly>
          </div>

          <div style="display:flex;gap:15px;margin-top:15px">
            <button class="login-btn" onclick="copyLink()">
              <i class="fas fa-copy"></i>
              <span>Copy Link</span>
            </button>

            <a id="coordOpenLink" href="../apply-coordinator.html" target="_blank" class="login-btn" style="text-decoration:none">
              <i class="fas fa-arrow-up-right-from-square"></i>
              <span>Open Form</span>
            </a>
          </div>
        </div>

        <!-- PAYMENT -->
        <div class="form-header">
          <h2>Payment Control</h2>
        </div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:30px">
          <a href="../payment.html" class="login-btn" style="text-decoration:none">
            <i class="fas fa-qrcode"></i>
            <span>UPI QR</span>
          </a>

          <button class="login-btn">
            <i class="fas fa-indian-rupee-sign"></i>
            <span>Set Fee</span>
          </button>
        </div>

        <!-- REPORTS -->
        <div class="form-header">
          <h2>Reports</h2>
          <p>Analytics & audit logs</p>
        </div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:30px">
          <a href="analytics.html" class="login-btn" style="text-decoration:none">
            <i class="fas fa-chart-line"></i>
            <span>Analytics & Audit</span>
          </a>
        </div>

        <!-- PAYMENT REQUESTS -->
        <div class="form-header">
          <h2>Payment Requests</h2>
          <p>Pending transaction verifications</p>
        </div>

        <div id="paymentRequests"></div>

        <!-- RECENT ACTIVITY -->
        <div class="form-header">
          <h2>Recent Activity</h2>
          <p>Latest events and applications</p>
        </div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:30px">
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:12px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);">
            <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Events</div>
              <div id="eventCount" style="font-size:1.25rem;font-weight:700;color:var(--text-primary);">0</div>
            </div>
          </div>

          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:12px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);">
            <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#48bb78,#38a169);display:flex;align-items:center;justify-content:center;color:white;">
              <i class="fas fa-layer-group"></i>
            </div>
            <div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Sub-events</div>
              <div id="subEventCount" style="font-size:1.25rem;font-weight:700;color:var(--text-primary);">0</div>
            </div>
          </div>

          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:12px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);">
            <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#4299e1,#3182ce);display:flex;align-items:center;justify-content:center;color:white;">
              <i class="fas fa-users"></i>
            </div>
            <div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Registrations</div>
              <div id="registrationCount" style="font-size:1.25rem;font-weight:700;color:var(--text-primary);">0</div>
            </div>
          </div>

          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:12px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);">
            <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#f6ad55,#ed8936);display:flex;align-items:center;justify-content:center;color:white;">
              <i class="fas fa-user-clock"></i>
            </div>
            <div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Pending Apps</div>
              <div id="pendingAppsCount" style="font-size:1.25rem;font-weight:700;color:var(--text-primary);">0</div>
            </div>
          </div>
        </div>

        <!-- APPROVAL FLOW -->
        <div class="form-header">
          <h2>Approval Workflow</h2>
        </div>

        <div style="display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:12px;margin-bottom:20px">
          <div class="input-group"><input id="wfPresident" disabled value="President ⏳" style="padding:16px 10px;text-align:center;font-size:0.95rem;font-weight:600;min-height:54px;"></div>
          <div class="input-group"><input id="wfFaculty" disabled value="Faculty ⏳" style="padding:16px 10px;text-align:center;font-size:0.95rem;font-weight:600;min-height:54px;"></div>
          <div class="input-group"><input id="wfHod" disabled value="HOD ⏳" style="padding:16px 10px;text-align:center;font-size:0.95rem;font-weight:600;min-height:54px;"></div>
          <div class="input-group"><input id="wfDean" disabled value="Dean ⏳" style="padding:16px 10px;text-align:center;font-size:0.95rem;font-weight:600;min-height:54px;"></div>
          <div class="input-group"><input id="wfVp" disabled value="VP ⏳" style="padding:16px 10px;text-align:center;font-size:0.95rem;font-weight:600;min-height:54px;"></div>
        </div>

        <button class="login-btn" id="sendApprovalBtn">
          <i class="fas fa-paper-plane"></i>
          <span>Send for Approval</span>
        </button>

      </div>
    </div>

  </div>
</div>

<!-- JS -->
<script src="../js/main.js"></script>

<script>
function copyLink() {
  const input = document.getElementById("coordLink");
  const value = input ? input.value : "";
  if (navigator.clipboard && value) {
    navigator.clipboard.writeText(value).then(() => {
      alert("Coordinator link copied");
    }).catch(() => {
      input.select();
      document.execCommand("copy");
      alert("Coordinator link copied");
    });
    return;
  }
  input.select();
  document.execCommand("copy");
  alert("Coordinator link copied");
}

// Allow page scroll when content exceeds viewport
document.addEventListener("DOMContentLoaded", () => {
  document.body.style.overflow = "auto";
  const linkInput = document.getElementById("coordLink");
  const openLink = document.getElementById("coordOpenLink");
  if (linkInput) {
    const base = window.location.origin;
    const full = `${base}/apply-coordinator.html`;
    linkInput.value = full;
    if (openLink) openLink.href = full;
  }
});

const eventCountEl = document.getElementById("eventCount");
const subEventCountEl = document.getElementById("subEventCount");
const registrationCountEl = document.getElementById("registrationCount");
const pendingAppsCountEl = document.getElementById("pendingAppsCount");
const sendApprovalBtn = document.getElementById("sendApprovalBtn");
const paymentRequestsEl = document.getElementById("paymentRequests");
const wfInputs = {
  President: document.getElementById("wfPresident"),
  Faculty: document.getElementById("wfFaculty"),
  HOD: document.getElementById("wfHod"),
  Dean: document.getElementById("wfDean"),
  VP: document.getElementById("wfVp")
};

const APPROVAL_ORDER = ["President", "Faculty", "HOD", "Dean", "VP"];
const WORKFLOW_LABELS = {
  President: "President",
  Faculty: "Faculty",
  HOD: "HOD",
  Dean: "Dean",
  VP: "VP"
};

function labelFor(role) {
  return WORKFLOW_LABELS[role] || role;
}

function setWorkflowDefaults() {
  APPROVAL_ORDER.forEach(role => {
    if (wfInputs[role]) wfInputs[role].value = `${labelFor(role)} ⏳`;
  });
}

function updateWorkflowUI(event) {
  if (!event) {
    setWorkflowDefaults();
    return;
  }

  const status = event.approvalStatus || "Draft";
  const stage = event.approvalStage || "President";
  const history = Array.isArray(event.approvalHistory) ? event.approvalHistory : [];
  const approvedRoles = new Set(
    history.filter(h => h && h.action === "Approved" && h.by).map(h => h.by)
  );

  APPROVAL_ORDER.forEach(role => {
    if (!wfInputs[role]) return;

    if (status === "Revision Requested" && role === "President") {
      wfInputs[role].value = `${labelFor(role)} ✎`;
      return;
    }

    if (role === "President" && status !== "Draft") {
      wfInputs[role].value = `${labelFor(role)} ✔`;
      return;
    }

    if (approvedRoles.has(role)) {
      wfInputs[role].value = `${labelFor(role)} ✔`;
      return;
    }

    if (status === "Pending" && stage === role) {
      wfInputs[role].value = `${labelFor(role)} ⏳`;
      return;
    }

    wfInputs[role].value = `${labelFor(role)} ⏳`;
  });
}

function pickWorkflowEvent(events) {
  const storedId = localStorage.getItem("workflowEventId");
  if (storedId) {
    const match = events.find(e => String(e.id) === String(storedId));
    if (match) return match;
  }

  let latest = null;
  let latestTime = 0;
  events.forEach(e => {
    const history = Array.isArray(e.approvalHistory) ? e.approvalHistory : [];
    const last = history[history.length - 1];
    const time = last && last.at ? Date.parse(last.at) : 0;
    if (time > latestTime) {
      latestTime = time;
      latest = e;
    }
  });
  return latest || events[0];
}

async function fetchJSON(url) {
  const res = await fetch(url);
  return res.json();
}

async function loadSummary() {
  try {
    const events = await fetchJSON(`${API_BASE}/api/events`);
    const eventList = Array.isArray(events) ? events : [];

    const subEventLists = await Promise.all(
      eventList.map(e => fetchJSON(`${API_BASE}/api/subevents/${e.id}`))
    );
    const subEvents = subEventLists.flat().filter(Boolean);

    const registrationLists = await Promise.all(
      subEvents.map(se => fetchJSON(`${API_BASE}/api/registrations/${se.id}`))
    );
    const registrations = registrationLists.flat().filter(Boolean);

    const appsLists = await Promise.all(
      subEvents.map(se => fetchJSON(`${API_BASE}/api/applications/${se.id}`))
    );
    const applications = appsLists.flat().filter(Boolean);
    const pendingApps = applications.filter(a => a.status === "Pending");

    eventCountEl.textContent = eventList.length;
    subEventCountEl.textContent = subEvents.length;
    registrationCountEl.textContent = registrations.length;
    pendingAppsCountEl.textContent = pendingApps.length;

    updateWorkflowUI(pickWorkflowEvent(eventList));
  } catch (err) {
    console.error(err);
  }
}


function renderEmptyPayments() {
  if (!paymentRequestsEl) return;
  paymentRequestsEl.innerHTML = `
    <div style="border:1px solid var(--border-color);border-radius:16px;padding:20px;margin-bottom:20px">
      <p style="color:var(--text-muted);margin:0">No pending payments</p>
    </div>
  `;
}

async function loadPayments() {
  if (!paymentRequestsEl) return;
  const token = localStorage.getItem("token");
  if (!token) return;

  try {
    const res = await fetch(`${API_BASE}/api/payments`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const payments = await res.json();
    const pending = Array.isArray(payments) ? payments.filter(p => p.status === "Pending") : [];

    if (pending.length === 0) {
      renderEmptyPayments();
      return;
    }

    paymentRequestsEl.innerHTML = "";
    pending.forEach(p => {
      const card = document.createElement("div");
      card.style.border = "1px solid var(--border-color)";
      card.style.borderRadius = "16px";
      card.style.padding = "20px";
      card.style.marginBottom = "20px";
      card.innerHTML = `
        <h3 style="margin-bottom:8px">Txn: ${p.transactionId}</h3>
        <p style="color:var(--text-muted);margin-bottom:15px">
          Reg ID: ${p.registrationId || "N/A"} • Status: ${p.status}
        </p>
        <div style="display:flex;gap:15px">
          <button class="login-btn" style="background:#38a169" data-pay-action="Verified" data-pay-id="${p.id}">
            <i class="fas fa-check"></i>
            <span>Verify</span>
          </button>
          <button class="login-btn" style="background:#e53e3e" data-pay-action="Rejected" data-pay-id="${p.id}">
            <i class="fas fa-times"></i>
            <span>Reject</span>
          </button>
        </div>
      `;
      paymentRequestsEl.appendChild(card);
    });

    paymentRequestsEl.querySelectorAll("button[data-pay-id]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-pay-id");
        const status = btn.getAttribute("data-pay-action");
        await updatePaymentStatus(id, status);
      });
    });
  } catch (err) {
    console.error(err);
    renderEmptyPayments();
  }
}

async function updatePaymentStatus(id, status) {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("Login required");
    return;
  }
  const res = await fetch(`${API_BASE}/api/payments/${id}/status`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({ status })
  });
  const data = await res.json();
  if (data.success) {
    loadPayments();
  } else {
    alert(data.message || "Update failed");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadSummary();
  loadPayments();
});

async function handleApprovalFlow() {
  try {
    const events = await fetchJSON(`${API_BASE}/api/events`);
    if (!Array.isArray(events) || events.length === 0) {
      alert("No events found");
      return;
    }

    const list = events.map(e => {
      const status = e.approvalStatus || "Draft";
      const stage = e.approvalStage || "President";
      return `${e.id}: ${e.name} [${status} @ ${stage}]`;
    }).join("\n");

    const input = prompt(`Enter Event ID:\n${list}`);
    if (!input) return;
    const id = parseInt(input, 10);
    const event = events.find(e => e.id === id);
    if (!event) {
      alert("Invalid Event ID");
      return;
    }

    localStorage.setItem("workflowEventId", id);

    const approvalStatus = event.approvalStatus || "Draft";
    const approvalStage = event.approvalStage || "President";

    if (approvalStage !== "President") {
      alert(`Event is currently with ${approvalStage}`);
      return;
    }

    if (approvalStatus === "Pending") {
      alert("Event already sent for approval");
      return;
    }

    const res = await fetch(`${API_BASE}/api/events/${id}/send-approval`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    });
    const data = await res.json();
    if (data.success) {
      alert("Event sent for approval");
      loadSummary();
    } else {
      alert(data.message || "Failed to send");
    }
  } catch (err) {
    console.error(err);
    alert("Backend not reachable");
  }
}

if (sendApprovalBtn) {
  sendApprovalBtn.addEventListener("click", handleApprovalFlow);
}
</script>

</body>
</html>
