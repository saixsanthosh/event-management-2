<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analytics & Audit</title>

  <!-- MAIN CSS -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- GOOGLE FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- FONT AWESOME -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<script>
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user"));

if (!token || !user) {
  window.location.href = "../index.html";
}

if (user.role !== "President") {
  alert("Access denied");
  window.location.href = "../index.html";
}
</script>

<!-- THEME TOGGLE -->
<div class="theme-toggle" id="themeToggle">
  <i class="fas fa-moon"></i>
</div>

<!-- BACKGROUND -->
<div class="bg-animation">
  <div class="floating-shapes">
    <span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span>
  </div>
</div>

<!-- MAIN CONTAINER -->
<div class="login-container">
  <div class="login-box" style="display:block">

    <!-- RIGHT PANEL -->
    <div class="login-right" style="width:100%">
      <div class="login-form-container" style="max-width:100%">

        <div class="form-header">
          <h2>Analytics & Audit</h2>
          <p>Reports and system activity</p>
        </div>

        <div style="display:flex;gap:15px;margin-bottom:20px">
          <a href="president.html" class="login-btn" style="text-decoration:none">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Dashboard</span>
          </a>
        </div>

        <div class="form-header" style="margin-top:20px">
          <h2>Summary</h2>
          <p>Quick view of activity</p>
        </div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:30px">
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:12px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);">
            <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Events</div>
              <div id="analyticsEvents" style="font-size:1.25rem;font-weight:700;color:var(--text-primary);">0</div>
            </div>
          </div>

          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:12px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);">
            <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#48bb78,#38a169);display:flex;align-items:center;justify-content:center;color:white;">
              <i class="fas fa-layer-group"></i>
            </div>
            <div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Sub-events</div>
              <div id="analyticsSubEvents" style="font-size:1.25rem;font-weight:700;color:var(--text-primary);">0</div>
            </div>
          </div>

          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:12px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);">
            <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#4299e1,#3182ce);display:flex;align-items:center;justify-content:center;color:white;">
              <i class="fas fa-users"></i>
            </div>
            <div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Registrations</div>
              <div id="analyticsRegistrations" style="font-size:1.25rem;font-weight:700;color:var(--text-primary);">0</div>
            </div>
          </div>

          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:12px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);">
            <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#f6ad55,#ed8936);display:flex;align-items:center;justify-content:center;color:white;">
              <i class="fas fa-user-check"></i>
            </div>
            <div>
              <div style="font-size:0.85rem;color:var(--text-muted);">Applications</div>
              <div id="analyticsApplications" style="font-size:1.25rem;font-weight:700;color:var(--text-primary);">0</div>
            </div>
          </div>
        </div>

        <div class="form-header" style="margin-top:20px">
          <h2>Charts</h2>
          <p>Top sub-events by registrations</p>
        </div>

        <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);box-shadow:0 8px 20px rgba(0,0,0,0.06);margin-bottom:20px">
          <canvas id="topSubEventsChart" style="width:100%;height:240px"></canvas>
        </div>

        <div class="form-header" style="margin-top:10px">
          <h2>Payments Overview</h2>
          <p>Current payment status counts</p>
        </div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px">
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Pending</div>
            <div id="paymentPendingCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Verified</div>
            <div id="paymentVerifiedCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Rejected</div>
            <div id="paymentRejectedCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
        </div>

        <div class="form-header" style="margin-top:10px">
          <h2>Applications Overview</h2>
          <p>Coordinator/Volunteer request counts</p>
        </div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px">
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Pending</div>
            <div id="appPendingCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Approved</div>
            <div id="appApprovedCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Rejected</div>
            <div id="appRejectedCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
        </div>

        <div class="form-header" style="margin-top:10px">
          <h2>Event Drilldown</h2>
          <p>Select an event to view stats</p>
        </div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px">
          <div class="input-group">
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:6px">Event</div>
            <input id="eventSelect" list="eventList" placeholder="Select event">
            <datalist id="eventList"></datalist>
          </div>
          <div class="input-group">
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:6px">Event Status</div>
            <input id="eventStatus" disabled value="--">
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px">
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Sub-events</div>
            <div id="eventSubCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Registrations</div>
            <div id="eventRegCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
          <div style="border:2px solid var(--border-color);border-radius:16px;padding:16px;background:var(--input-bg);text-align:center">
            <div style="color:var(--text-muted);font-size:0.85rem">Applications</div>
            <div id="eventAppCount" style="font-size:1.3rem;font-weight:700;color:var(--text-primary)">0</div>
          </div>
        </div>

        <div class="form-header" style="margin-top:10px">
          <h2>Top Sub-events</h2>
          <p>Most registrations (overall)</p>
        </div>

        <div id="topSubEvents"></div>

        <div class="form-header" style="margin-top:20px">
          <h2>Audit Log</h2>
          <p>Latest system actions</p>
        </div>

        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px">
          <div class="input-group">
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:6px">Search</div>
            <input id="auditSearch" placeholder="Action, role, or details">
          </div>
          <div class="input-group">
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:6px">Role</div>
            <input id="auditRole" list="auditRoleList" placeholder="All roles">
            <datalist id="auditRoleList">
              <option value="President"></option>
              <option value="Faculty"></option>
              <option value="HOD"></option>
              <option value="Dean"></option>
              <option value="VP"></option>
              <option value="Coordinator"></option>
              <option value="Volunteer"></option>
              <option value="System"></option>
            </datalist>
          </div>
          <div class="input-group">
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:6px">From date</div>
            <input id="auditFrom" placeholder="YYYY-MM-DD">
          </div>
          <div class="input-group">
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:6px">To date</div>
            <input id="auditTo" placeholder="YYYY-MM-DD">
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
          <div class="input-group" style="max-width:180px">
            <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:6px">Limit</div>
            <input id="auditLimit" type="number" min="1" max="200" value="20" placeholder="1 - 200">
          </div>
          <button class="login-btn" id="auditApplyBtn">
            <i class="fas fa-filter"></i>
            <span>Apply</span>
          </button>
          <button class="login-btn" id="auditResetBtn" style="background:#64748b">
            <i class="fas fa-rotate-left"></i>
            <span>Reset</span>
          </button>
          <button class="login-btn" id="auditExportBtn" style="background:#38a169">
            <i class="fas fa-file-arrow-down"></i>
            <span>Export CSV</span>
          </button>
        </div>

        <div id="auditLog" style="max-height:360px;overflow:auto;padding-right:6px"></div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="../js/main.js"></script>
<script>
  const topSubEventsEl = document.getElementById("topSubEvents");
  const auditLogEl = document.getElementById("auditLog");
  const auditSearchEl = document.getElementById("auditSearch");
  const auditRoleEl = document.getElementById("auditRole");
  const auditFromEl = document.getElementById("auditFrom");
  const auditToEl = document.getElementById("auditTo");
  const auditLimitEl = document.getElementById("auditLimit");
  const auditApplyBtn = document.getElementById("auditApplyBtn");
  const auditResetBtn = document.getElementById("auditResetBtn");
  const auditExportBtn = document.getElementById("auditExportBtn");
  const topSubEventsChartEl = document.getElementById("topSubEventsChart");
  const paymentPendingEl = document.getElementById("paymentPendingCount");
  const paymentVerifiedEl = document.getElementById("paymentVerifiedCount");
  const paymentRejectedEl = document.getElementById("paymentRejectedCount");
  const appPendingEl = document.getElementById("appPendingCount");
  const appApprovedEl = document.getElementById("appApprovedCount");
  const appRejectedEl = document.getElementById("appRejectedCount");
  const eventSelectEl = document.getElementById("eventSelect");
  const eventListEl = document.getElementById("eventList");
  const eventStatusEl = document.getElementById("eventStatus");
  const eventSubCountEl = document.getElementById("eventSubCount");
  const eventRegCountEl = document.getElementById("eventRegCount");
  const eventAppCountEl = document.getElementById("eventAppCount");
  let cachedEvents = [];
  let cachedSubEvents = [];
  let lastAuditLogs = [];

  function getToken() {
    return localStorage.getItem("token");
  }

  function renderEmptyTopSubEvents() {
    if (!topSubEventsEl) return;
    topSubEventsEl.innerHTML = `
      <div class="input-group">
        <input disabled value="No sub-events yet">
      </div>
    `;
  }

  function renderEmptyAuditLog() {
    if (!auditLogEl) return;
    auditLogEl.innerHTML = `
      <div style="border:1px solid var(--border-color);border-radius:16px;padding:16px;margin-bottom:12px">
        <p style="color:var(--text-muted);margin:0">No audit entries yet</p>
      </div>
    `;
  }


  function setCount(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = typeof value === "number" ? value : 0;
  }

  function setText(el, value) {
    if (!el) return;
    el.textContent = value || "0";
  }

  function drawBarChart(canvas, labels, values) {
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    ctx.clearRect(0, 0, rect.width, rect.height);
    const padding = 30;
    const chartWidth = rect.width - padding * 2;
    const chartHeight = rect.height - padding * 2;
    const max = Math.max(...values, 1);
    const barGap = 12;
    const barWidth = Math.max(24, (chartWidth - barGap * (values.length - 1)) / values.length);

    ctx.font = "12px Poppins, sans-serif";
    ctx.fillStyle = "#94a3b8";
    ctx.textAlign = "center";

    values.forEach((v, i) => {
      const x = padding + i * (barWidth + barGap);
      const barHeight = Math.max(4, (v / max) * chartHeight);
      const y = padding + (chartHeight - barHeight);

      const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
      gradient.addColorStop(0, "#667eea");
      gradient.addColorStop(1, "#764ba2");
      ctx.fillStyle = gradient;
      ctx.fillRect(x, y, barWidth, barHeight);

      ctx.fillStyle = "#1f2937";
      ctx.fillText(String(v), x + barWidth / 2, y - 6);

      ctx.fillStyle = "#94a3b8";
      const label = labels[i] ? labels[i].slice(0, 10) : "";
      ctx.fillText(label, x + barWidth / 2, rect.height - 8);
    });
  }

  function buildAuditQuery() {
    const params = new URLSearchParams();
    const limit = Math.max(1, Math.min(200, parseInt((auditLimitEl && auditLimitEl.value) || "20", 10)));
    params.set("limit", String(limit));

    const q = auditSearchEl ? auditSearchEl.value.trim() : "";
    const role = auditRoleEl ? auditRoleEl.value.trim() : "";
    const from = auditFromEl ? auditFromEl.value.trim() : "";
    const to = auditToEl ? auditToEl.value.trim() : "";

    if (q) params.set("q", q);
    if (role) params.set("role", role);
    if (from) params.set("from", from);
    if (to) params.set("to", to);

    return params.toString();
  }

  function exportAuditCsv() {
    if (!Array.isArray(lastAuditLogs) || lastAuditLogs.length === 0) {
      alert("No audit data to export");
      return;
    }
    const escapeCsv = (val) => {
      const str = String(val ?? "");
      if (str.includes("\"")) {
        return `"${str.replace(/\"/g, "\"\"")}"`;
      }
      if (str.includes(",") || str.includes("\n")) {
        return `"${str}"`;
      }
      return str;
    };

    const header = ["id", "action", "details", "role", "actor", "timestamp"];
    const rows = lastAuditLogs.map((log) => [
      log.id,
      log.action,
      log.details,
      log.role,
      log.actor,
      log.at
    ]);
    const csv = [header.join(","), ...rows.map((r) => r.map(escapeCsv).join(","))].join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "audit-log.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  async function loadAnalytics() {
    const token = getToken();
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE}/api/analytics`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();

      setCount("analyticsEvents", data.events || 0);
      setCount("analyticsSubEvents", data.subEvents || 0);
      setCount("analyticsRegistrations", data.registrations || 0);
      setCount("analyticsApplications", data.applications || 0);

      const top = Array.isArray(data.topSubEvents) ? data.topSubEvents : [];
      if (top.length === 0) {
        renderEmptyTopSubEvents();
        return;
      }

      topSubEventsEl.innerHTML = "";
      top.forEach(item => {
        const row = document.createElement("div");
        row.className = "input-group";
        row.innerHTML = `<input disabled value="${item.name} — ${item.registrations} regs">`;
        topSubEventsEl.appendChild(row);
      });

      if (topSubEventsChartEl) {
        const labels = top.map(t => t.name);
        const values = top.map(t => t.registrations);
        drawBarChart(topSubEventsChartEl, labels, values);
      }

      const paymentCounts = data.paymentStatusCounts || {};
      setText(paymentPendingEl, paymentCounts.Pending || 0);
      setText(paymentVerifiedEl, paymentCounts.Verified || 0);
      setText(paymentRejectedEl, paymentCounts.Rejected || 0);

      const appCounts = data.appStatusCounts || {};
      setText(appPendingEl, appCounts.Pending || 0);
      setText(appApprovedEl, appCounts.Approved || 0);
      setText(appRejectedEl, appCounts.Rejected || 0);
    } catch (err) {
      console.error(err);
      renderEmptyTopSubEvents();
    }
  }

  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) throw new Error("Request failed");
    return res.json();
  }

  async function loadEventList() {
    try {
      cachedEvents = await fetchJSON(`${API_BASE}/api/events`);
      if (!Array.isArray(cachedEvents)) cachedEvents = [];
      if (eventListEl) {
        eventListEl.innerHTML = "";
        cachedEvents.forEach(evt => {
          const opt = document.createElement("option");
          opt.value = evt.name;
          eventListEl.appendChild(opt);
        });
      }
      if (cachedEvents.length > 0 && eventSelectEl && !eventSelectEl.value) {
        eventSelectEl.value = cachedEvents[0].name;
        loadEventDrilldownByName(cachedEvents[0].name);
      }
    } catch (err) {
      console.error(err);
    }
  }

  async function loadEventDrilldownByName(name) {
    const evt = cachedEvents.find(e => e.name === name);
    if (!evt) {
      if (eventStatusEl) eventStatusEl.value = "--";
      setText(eventSubCountEl, 0);
      setText(eventRegCountEl, 0);
      setText(eventAppCountEl, 0);
      return;
    }
    await loadEventDrilldown(evt.id, evt);
  }

  async function loadEventDrilldown(eventId, evtMeta) {
    try {
      const subEvents = await fetchJSON(`${API_BASE}/api/subevents/${eventId}`);
      cachedSubEvents = Array.isArray(subEvents) ? subEvents : [];
      if (eventStatusEl) eventStatusEl.value = evtMeta && evtMeta.status ? evtMeta.status : "Upcoming";

      const counts = await Promise.all(cachedSubEvents.map(async (se) => {
        const [regs, apps] = await Promise.all([
          fetchJSON(`${API_BASE}/api/registrations/${se.id}`),
          fetchJSON(`${API_BASE}/api/applications/${se.id}`)
        ]);
        return {
          subEvent: se,
          regCount: Array.isArray(regs) ? regs.length : 0,
          appCount: Array.isArray(apps) ? apps.length : 0
        };
      }));

      const totalRegs = counts.reduce((sum, c) => sum + c.regCount, 0);
      const totalApps = counts.reduce((sum, c) => sum + c.appCount, 0);

      setText(eventSubCountEl, cachedSubEvents.length);
      setText(eventRegCountEl, totalRegs);
      setText(eventAppCountEl, totalApps);
    } catch (err) {
      console.error(err);
      setText(eventSubCountEl, 0);
      setText(eventRegCountEl, 0);
      setText(eventAppCountEl, 0);
    }
  }

  async function loadAuditLog() {
    const token = getToken();
    if (!token) return;

    try {
      const query = buildAuditQuery();
      const res = await fetch(`${API_BASE}/api/audit?${query}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const logs = await res.json();
      lastAuditLogs = Array.isArray(logs) ? logs : [];
      if (!Array.isArray(logs) || logs.length === 0) {
        renderEmptyAuditLog();
        renderActivityFeed([]);
        return;
      }

      auditLogEl.innerHTML = "";
      logs.forEach(log => {
        const card = document.createElement("div");
        card.style.border = "1px solid var(--border-color)";
        card.style.borderRadius = "16px";
        card.style.padding = "16px";
        card.style.marginBottom = "12px";
        card.style.color = "var(--text-primary)";
        const time = log.at ? new Date(log.at).toLocaleString() : "";
        card.innerHTML = `
          <div style="font-weight:600;margin-bottom:6px">${log.action}</div>
          <div style="color:var(--text-muted);font-size:0.9rem">${log.details || ""}</div>
          <div style="color:var(--text-muted);font-size:0.85rem;margin-top:6px">Role: ${log.role || "System"} • Actor: ${log.actor || "System"}</div>
          ${time ? `<div style="color:var(--text-muted);font-size:0.8rem;margin-top:6px">${time}</div>` : ""}
        `;
        auditLogEl.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      renderEmptyAuditLog();
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.body.style.overflow = "auto";
    loadAnalytics();
    loadAuditLog();
    loadEventList();
    if (eventSelectEl) {
      eventSelectEl.addEventListener("change", (e) => {
        loadEventDrilldownByName(e.target.value);
      });
    }
    if (auditApplyBtn) auditApplyBtn.addEventListener("click", loadAuditLog);
    if (auditResetBtn) {
      auditResetBtn.addEventListener("click", () => {
        if (auditSearchEl) auditSearchEl.value = "";
        if (auditRoleEl) auditRoleEl.value = "";
        if (auditFromEl) auditFromEl.value = "";
        if (auditToEl) auditToEl.value = "";
        if (auditLimitEl) auditLimitEl.value = "20";
        loadAuditLog();
      });
    }
    if (auditExportBtn) auditExportBtn.addEventListener("click", exportAuditCsv);
  });
</script>

</body>
</html>
