<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coordinator Dashboard</title>

    <!-- MAIN CSS -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- GOOGLE FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <script>
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user"));

if (!token || !user) {
  window.location.href = "../index.html";
}

if (user.role !== "Coordinator") {
  alert("Access denied");
  window.location.href = "../index.html";
}
</script>

<!-- THEME TOGGLE -->
<div class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
</div>

<!-- BACKGROUND -->
<div class="bg-animation">
    <div class="floating-shapes">
        <span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span>
    </div>
</div>

<!-- MAIN CONTAINER -->
<div class="login-container">
    <div class="login-box">

        <!-- LEFT SIDE -->
        <div class="login-left" style="flex:0 0 25%;max-width:25%">
            <div class="brand-content">
                <div class="logo-icon">
                    <i class="fas fa-user-cog"></i>
                </div>

                <h1>Coordinator Panel</h1>
                <p>Manage your assigned sub-events</p>

                <div class="features-list">
                    <div class="feature-item">
                        <i class="fas fa-users"></i>
                        <span>View Participants</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-qrcode"></i>
                        <span>QR Verification</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-user-check"></i>
                        <span>Mark Attendance</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE -->
        <div class="login-right" style="flex:0 0 75%;max-width:75%">
            <div class="login-form-container" style="max-width:100%">

                <div class="form-header">
                    <h2>Assigned Sub-Event</h2>
                    <p id="assignedSubEventLabel">Loading...</p>
                </div>

                <div class="panel-switch">
                    <button id="showAttendanceBtn" class="panel-switch-btn active" type="button">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Attendance & Payments</span>
                    </button>
                    <button id="showResultsBtn" class="panel-switch-btn" type="button">
                        <i class="fas fa-trophy"></i>
                        <span>Event Results</span>
                    </button>
                </div>

                <div id="attendancePanel" class="content-panel">
                    <div style="border:2px dashed var(--border-color);padding:18px;border-radius:16px;margin-bottom:20px;background:var(--input-bg)">
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px">
                            <div style="font-size:1rem;color:var(--text-primary);font-weight:600">Add Offline Participant</div>
                            <div style="font-size:0.82rem;color:var(--text-muted)">For late or offline enrollments</div>
                        </div>
                        <form id="offlineAddForm" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
                            <div class="input-group" style="margin-bottom:0"><input id="offlineName" placeholder="Full Name" required /></div>
                            <div class="input-group" style="margin-bottom:0"><input id="offlineCollege" placeholder="College Name" required /></div>
                            <div class="input-group" style="margin-bottom:0"><input id="offlineDepartment" placeholder="Department / Class" required /></div>
                            <div class="input-group" style="margin-bottom:0"><input id="offlineEmail" type="email" placeholder="Email ID" required /></div>
                            <div class="input-group" style="margin-bottom:0"><input id="offlineMobile" type="tel" placeholder="Mobile Number" required /></div>
                            <div class="input-group" style="margin-bottom:0">
                                <select id="offlinePaymentStatus" style="width:100%;padding:18px;border-radius:12px;border:2px solid var(--border-color);background:var(--card-bg);color:var(--text-primary)">
                                    <option value="Pending">Payment: Pending</option>
                                    <option value="Paid">Payment: Paid</option>
                                    <option value="Rejected">Payment: Rejected</option>
                                </select>
                            </div>
                            <div style="grid-column:1/-1;display:flex;justify-content:flex-start">
                                <button class="login-btn" type="submit" style="width:auto;padding:12px 18px">
                                    <i class="fas fa-user-plus"></i>
                                    <span>Add Participant</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px">
                        <div style="font-size:1rem;color:var(--text-primary);font-weight:600">Participants</div>
                        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                            <div style="font-size:0.82rem;color:var(--text-muted)">Use attendance checkbox or delete button to update list</div>
                            <button class="login-btn" id="submitAttendanceBtn" type="button" style="width:auto;padding:10px 14px">
                                <i class="fas fa-check-circle"></i>
                                <span>Submit Attendance</span>
                            </button>
                        </div>
                    </div>

                    <div style="overflow-x:auto;max-height:360px;overflow-y:auto;padding-right:6px">
                        <table style="width:100%;border-collapse:collapse;color:var(--text-primary)">
                            <thead>
                                <tr style="background:var(--input-bg)">
                                    <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">Name</th>
                                    <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">College</th>
                                    <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">Payment</th>
                                    <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">QR</th>
                                    <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">Attendance</th>
                                    <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">Delete</th>
                                </tr>
                            </thead>
                            <tbody id="studentList"></tbody>
                        </table>
                    </div>
                </div>

                <div id="resultsPanel" class="content-panel hidden">
                    <div style="border:2px dashed var(--border-color);padding:18px;border-radius:16px;margin-bottom:16px;background:var(--input-bg)">
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px">
                            <div style="font-size:1rem;color:var(--text-primary);font-weight:600">
                                Sub-event Results
                            </div>
                            <div id="resultEventStatus" style="font-size:0.82rem;color:var(--text-secondary);border:1px solid var(--border-color);padding:6px 10px;border-radius:999px">
                                Status: -
                            </div>
                        </div>

                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:12px">
                            <div class="input-group" style="margin-bottom:0">
                                <input id="winnerInput" placeholder="Winner" />
                            </div>
                            <div class="input-group" style="margin-bottom:0">
                                <input id="runnerUpInput" placeholder="Runner-up" />
                            </div>
                            <div class="input-group" style="margin-bottom:0">
                                <input id="thirdPlaceInput" placeholder="Third Place" />
                            </div>
                        </div>

                        <p id="resultHint" style="color:var(--text-muted);font-size:0.82rem;margin:0 0 12px 0">
                            Results can be updated only when event status is Completed.
                        </p>

                        <button class="login-btn" id="saveResultsBtn" style="width:auto;padding:12px 18px">
                            <i class="fas fa-trophy"></i>
                            <span>Save Results</span>
                        </button>
                    </div>

                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px">
                        <div style="border:1px solid var(--border-color);border-radius:14px;padding:14px;background:var(--card-bg)">
                            <div style="font-size:0.95rem;color:var(--text-primary);font-weight:700;margin-bottom:8px">Event Winners</div>
                            <div id="publishedResultsBox" style="color:var(--text-secondary);font-size:0.9rem;line-height:1.6"></div>
                        </div>
                        <div style="border:1px solid var(--border-color);border-radius:14px;padding:14px;background:var(--card-bg)">
                            <div style="font-size:0.95rem;color:var(--text-primary);font-weight:700;margin-bottom:8px">Participants</div>
                            <div id="resultParticipantsList" style="max-height:220px;overflow:auto;padding-right:4px;color:var(--text-secondary);font-size:0.9rem;line-height:1.5"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<!-- MAIN JS -->
<script src="../js/main.js"></script>

<script>
  const labelEl = document.getElementById("assignedSubEventLabel");
  const listEl = document.getElementById("studentList");
  const statusEl = document.getElementById("resultEventStatus");
  const hintEl = document.getElementById("resultHint");
  const winnerInput = document.getElementById("winnerInput");
  const runnerUpInput = document.getElementById("runnerUpInput");
  const thirdPlaceInput = document.getElementById("thirdPlaceInput");
  const saveResultsBtn = document.getElementById("saveResultsBtn");
  const attendancePanel = document.getElementById("attendancePanel");
  const resultsPanel = document.getElementById("resultsPanel");
  const showAttendanceBtn = document.getElementById("showAttendanceBtn");
  const showResultsBtn = document.getElementById("showResultsBtn");
  const offlineAddForm = document.getElementById("offlineAddForm");
  const submitAttendanceBtn = document.getElementById("submitAttendanceBtn");
  const publishedResultsBox = document.getElementById("publishedResultsBox");
  const resultParticipantsList = document.getElementById("resultParticipantsList");
  const offlineName = document.getElementById("offlineName");
  const offlineCollege = document.getElementById("offlineCollege");
  const offlineDepartment = document.getElementById("offlineDepartment");
  const offlineEmail = document.getElementById("offlineEmail");
  const offlineMobile = document.getElementById("offlineMobile");
  const offlinePaymentStatus = document.getElementById("offlinePaymentStatus");
  const REGISTRATION_AUTO_REFRESH_MS = 8000;

  let currentEvent = null;
  let currentSubEvent = null;
  let currentRegistrations = [];
  let registrationsSnapshot = "[]";
  let registrationsAutoRefreshTimer = null;
  let registrationsRefreshInFlight = false;

  function showConfirm(options) {
      if (window.uiConfirm) return window.uiConfirm(options);
      return Promise.resolve(window.confirm(options && options.message ? options.message : "Are you sure?"));
  }

  function showPrompt(options) {
      if (window.uiPrompt) return window.uiPrompt(options);
      return Promise.resolve(
          window.prompt(
              options && options.message ? options.message : "Enter value",
              options && options.defaultValue != null ? String(options.defaultValue) : ""
          )
      );
  }

  function esc(value) {
      return String(value == null ? "" : value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
  }

  async function fetchJSON(url, options = {}) {
      const res = await fetch(url, options);
      const data = await res.json();
      if (!res.ok) {
          throw new Error(data && data.message ? data.message : `Request failed (${res.status})`);
      }
      return data;
  }

  function getToken() {
      return localStorage.getItem("token");
  }

  function setActivePanel(panel) {
      const showAttendance = panel === "attendance";
      attendancePanel.classList.toggle("hidden", !showAttendance);
      resultsPanel.classList.toggle("hidden", showAttendance);
      showAttendanceBtn.classList.toggle("active", showAttendance);
      showResultsBtn.classList.toggle("active", !showAttendance);
  }

  function renderPublishedResults(subEvent) {
      const results = subEvent && subEvent.results && typeof subEvent.results === "object" ? subEvent.results : {};
      const winner = results.winner || "-";
      const runnerUp = results.runnerUp || "-";
      const thirdPlace = results.thirdPlace || "-";
      const updatedAt = results.updatedAt ? new Date(results.updatedAt).toLocaleString() : "-";
      const updatedBy = results.updatedBy || "-";
      publishedResultsBox.innerHTML = `
        <div><strong>Winner:</strong> ${esc(winner)}</div>
        <div><strong>Runner-up:</strong> ${esc(runnerUp)}</div>
        <div><strong>Third Place:</strong> ${esc(thirdPlace)}</div>
        <div style="margin-top:8px;color:var(--text-muted);font-size:0.82rem">Updated: ${esc(updatedAt)} by ${esc(updatedBy)}</div>
      `;
  }

  function renderResultParticipants(participants) {
      const list = Array.isArray(participants) ? participants : [];
      if (list.length === 0) {
          resultParticipantsList.innerHTML = `<div style="color:var(--text-muted)">No participants yet</div>`;
          return;
      }
      resultParticipantsList.innerHTML = list
          .map((participant, index) => {
              const name = participant && typeof participant === "object" ? participant.name : participant;
              const college = participant && typeof participant === "object" ? participant.college : "";
              return `<div style="padding:6px 0;border-bottom:1px solid rgba(102,126,234,0.15)">${index + 1}. ${esc(name || "-")} <span style="color:var(--text-muted)">(${esc(college || "-")})</span></div>`;
          })
          .join("");
  }

  function setResultEditorState(event, subEvent) {
      currentEvent = event || null;
      currentSubEvent = subEvent || null;
      const status = event && event.status ? event.status : "Unknown";
      statusEl.textContent = `Status: ${status}`;

      const isCompleted = status === "Completed";
      const results = subEvent && subEvent.results && typeof subEvent.results === "object" ? subEvent.results : {};

      winnerInput.value = "";
      runnerUpInput.value = "";
      thirdPlaceInput.value = "";
      winnerInput.placeholder = results.winner ? `Current: ${results.winner}` : "Winner";
      runnerUpInput.placeholder = results.runnerUp ? `Current: ${results.runnerUp}` : "Runner-up";
      thirdPlaceInput.placeholder = results.thirdPlace ? `Current: ${results.thirdPlace}` : "Third Place";

      [winnerInput, runnerUpInput, thirdPlaceInput, saveResultsBtn].forEach((el) => {
          if (!el) return;
          el.disabled = !isCompleted;
      });

      if (isCompleted) {
          hintEl.textContent = "Add or update Winner, Runner-up, and Third Place, then save.";
      } else if (status === "Unknown") {
          hintEl.textContent = "Select a sub-event to load event and result details.";
      } else {
          hintEl.textContent = "Results can be updated only when event status is Completed.";
      }
      renderPublishedResults(subEvent || {});
      const publishedParticipants = results && Array.isArray(results.participants) ? results.participants : [];
      renderResultParticipants(publishedParticipants);
  }

  async function updateAttendance(registrationId, attendance) {
      const token = getToken();
      if (!token) {
          alert("Login required");
          return;
      }
      try {
          await fetchJSON(`${API_BASE}/api/registrations/${registrationId}/attendance`, {
              method: "PUT",
              headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({ attendance })
          });
      } catch (err) {
          alert(err.message || "Failed to update attendance");
      }
  }

  async function deleteRegistration(registrationId) {
      const token = getToken();
      if (!token) {
          alert("Login required");
          return;
      }
      const confirmed = await showConfirm({
          title: "Delete Participant",
          message: "Delete this participant from the sub-event?"
      });
      if (!confirmed) return;
      try {
          await fetchJSON(`${API_BASE}/api/registrations/${registrationId}`, {
              method: "DELETE",
              headers: { "Authorization": `Bearer ${token}` }
          });
          await loadRegistrations(currentSubEvent.id);
      } catch (err) {
          alert(err.message || "Failed to delete participant");
      }
  }

  function attachTableActions() {
      listEl.querySelectorAll('input[data-action="attendance"]').forEach((checkbox) => {
          checkbox.addEventListener("change", async (e) => {
              const id = Number.parseInt(e.currentTarget.dataset.id, 10);
              if (!Number.isFinite(id)) return;
              await updateAttendance(id, Boolean(e.currentTarget.checked));
          });
      });
      listEl.querySelectorAll('button[data-action="delete-participant"]').forEach((button) => {
          button.addEventListener("click", async (e) => {
              const id = Number.parseInt(e.currentTarget.dataset.id, 10);
              if (!Number.isFinite(id)) return;
              await deleteRegistration(id);
          });
      });
  }

  function renderStudents(registrations) {
      listEl.innerHTML = "";
      currentRegistrations = Array.isArray(registrations) ? registrations : [];
      registrationsSnapshot = JSON.stringify(
          currentRegistrations
              .map((r) => ({
                  id: Number.parseInt(r.id, 10) || 0,
                  paymentStatus: String(r.paymentStatus || ""),
                  attendance: Boolean(r.attendance)
              }))
              .sort((a, b) => a.id - b.id)
      );

      if (currentRegistrations.length === 0) {
          listEl.innerHTML = `
            <tr>
              <td colspan="6" style="padding:12px;border:1px solid var(--border-color);text-align:center;color:var(--text-muted)">
                No registrations yet
              </td>
            </tr>
          `;
          return;
      }

      currentRegistrations.forEach((r) => {
          const payment = r.paymentStatus || "Pending";
          const qr = payment === "Paid" ? "Generated" : "Not Generated";
          listEl.innerHTML += `
              <tr>
                  <td style="padding:10px;border:1px solid var(--border-color)">${esc(r.name)}</td>
                  <td style="padding:10px;border:1px solid var(--border-color)">${esc(r.college)}</td>
                  <td style="padding:10px;border:1px solid var(--border-color);color:${payment === 'Paid' ? '#38a169' : '#e53e3e'}">${esc(payment)}</td>
                  <td style="padding:10px;border:1px solid var(--border-color)">${esc(qr)}</td>
                  <td style="padding:10px;border:1px solid var(--border-color);text-align:center">
                      <input type="checkbox" data-action="attendance" data-id="${r.id}" ${r.attendance ? "checked" : ""}>
                  </td>
                  <td style="padding:10px;border:1px solid var(--border-color);text-align:center">
                      <button class="login-btn" data-action="delete-participant" data-id="${r.id}" style="width:auto;padding:8px 12px;background:linear-gradient(135deg,#fc8181,#f56565)">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                      </button>
                  </td>
              </tr>
          `;
      });
      attachTableActions();
  }

  async function loadRegistrations(subEventId) {
      const registrations = await fetchJSON(`${API_BASE}/api/registrations/${subEventId}`);
      renderStudents(registrations);
  }

  async function refreshRegistrationsSilently() {
      if (!currentSubEvent || !currentSubEvent.id || registrationsRefreshInFlight) return;
      registrationsRefreshInFlight = true;
      try {
          const latest = await fetchJSON(`${API_BASE}/api/registrations/${currentSubEvent.id}`);
          const nextSnapshot = JSON.stringify(
              (Array.isArray(latest) ? latest : [])
                  .map((r) => ({
                      id: Number.parseInt(r.id, 10) || 0,
                      paymentStatus: String(r.paymentStatus || ""),
                      attendance: Boolean(r.attendance)
                  }))
                  .sort((a, b) => a.id - b.id)
          );
          if (nextSnapshot !== registrationsSnapshot) {
              renderStudents(latest);
          }
      } catch (_) {
          // Ignore transient polling failures and keep current UI.
      } finally {
          registrationsRefreshInFlight = false;
      }
  }

  function startRegistrationsAutoRefresh() {
      if (registrationsAutoRefreshTimer) {
          clearInterval(registrationsAutoRefreshTimer);
      }
      registrationsAutoRefreshTimer = setInterval(() => {
          if (!document.hidden) {
              refreshRegistrationsSilently();
          }
      }, REGISTRATION_AUTO_REFRESH_MS);
  }

  function stopRegistrationsAutoRefresh() {
      if (!registrationsAutoRefreshTimer) return;
      clearInterval(registrationsAutoRefreshTimer);
      registrationsAutoRefreshTimer = null;
  }

  async function submitAttendanceParticipants() {
      if (!currentSubEvent || !currentSubEvent.id) {
          alert("No sub-event selected");
          return;
      }
      const attendedCount = currentRegistrations.filter((item) => Boolean(item.attendance)).length;
      if (attendedCount === 0) {
          alert("Mark attendance for at least one participant before submitting.");
          return;
      }

      const confirmed = await showConfirm({
          title: "Submit Attendance",
          message: `Submit ${attendedCount} attended participants to Event Results list?`
      });
      if (!confirmed) return;

      const token = getToken();
      if (!token) {
          alert("Login required");
          return;
      }

      try {
          const data = await fetchJSON(`${API_BASE}/api/subevents/${currentSubEvent.id}/participants`, {
              method: "PUT",
              headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
              }
          });
          if (!data.success) {
              alert(data.message || "Failed to submit attendance");
              return;
          }
          currentSubEvent = data.subEvent || currentSubEvent;
          setResultEditorState(currentEvent, currentSubEvent);
          alert(`Attendance submitted. ${data.count} participants published to event results.`);
      } catch (err) {
          alert(err.message || "Failed to submit attendance");
      }
  }

  async function saveSubEventResults() {
      if (!currentSubEvent || !currentSubEvent.id) {
          alert("No sub-event selected");
          return;
      }

      const token = getToken();
      if (!token) {
          alert("Login required");
          return;
      }

      const draft = {
          winner: winnerInput.value.trim(),
          runnerUp: runnerUpInput.value.trim(),
          thirdPlace: thirdPlaceInput.value.trim()
      };

      try {
          const latestSubEvent = await fetchJSON(`${API_BASE}/api/subevents/detail/${currentSubEvent.id}`);
          currentSubEvent = latestSubEvent || currentSubEvent;

          const latestEvent = await fetchJSON(`${API_BASE}/api/events/${currentSubEvent.eventId}`);
          currentEvent = latestEvent || currentEvent;
          statusEl.textContent = `Status: ${currentEvent && currentEvent.status ? currentEvent.status : "Unknown"}`;

          if (!latestEvent || latestEvent.status !== "Completed") {
              setResultEditorState(latestEvent, latestSubEvent);
              alert("Event must be Completed before updating results.");
              return;
          }

          const payload = {
              winner: draft.winner || ((latestSubEvent.results && latestSubEvent.results.winner) || ""),
              runnerUp: draft.runnerUp || ((latestSubEvent.results && latestSubEvent.results.runnerUp) || ""),
              thirdPlace: draft.thirdPlace || ((latestSubEvent.results && latestSubEvent.results.thirdPlace) || "")
          };
          if (!payload.winner && !payload.runnerUp && !payload.thirdPlace) {
              alert("Enter at least one result");
              return;
          }

          const data = await fetchJSON(`${API_BASE}/api/subevents/${currentSubEvent.id}/results`, {
              method: "PUT",
              headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify(payload)
          });
          if (data.success) {
              setResultEditorState(latestEvent, data.subEvent || latestSubEvent);
              hintEl.textContent = "Results saved.";
              const summary = data.emailSummary || {};
              const sent = Number(summary.sent || 0);
              const failed = Number(summary.failed || 0);
              const skipped = Number(summary.skipped || 0);
              let info = "Results updated";
              if (sent || failed || skipped) {
                  info += `\nWinner emails -> Sent: ${sent}, Failed: ${failed}, Skipped: ${skipped}`;
              }
              alert(info);
          } else {
              alert(data.message || "Failed to update results");
          }
      } catch (err) {
          console.error(err);
          alert(err.message || "Failed to update results");
      }
  }

  async function addManualParticipant(e) {
      e.preventDefault();
      if (!currentSubEvent || !currentSubEvent.id) {
          alert("Select a sub-event first");
          return;
      }
      const token = getToken();
      if (!token) {
          alert("Login required");
          return;
      }

      const payload = {
          subEventId: currentSubEvent.id,
          name: offlineName.value.trim(),
          college: offlineCollege.value.trim(),
          department: offlineDepartment.value.trim(),
          email: offlineEmail.value.trim(),
          mobile: offlineMobile.value.trim(),
          paymentStatus: offlinePaymentStatus.value
      };
      if (!payload.name || !payload.college || !payload.department || !payload.email || !payload.mobile) {
          alert("Fill all participant fields");
          return;
      }

      try {
          const data = await fetchJSON(`${API_BASE}/api/registrations/manual`, {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify(payload)
          });
          if (!data.success) {
              alert(data.message || "Unable to add participant");
              return;
          }
          offlineAddForm.reset();
          await loadRegistrations(currentSubEvent.id);
      } catch (err) {
          alert(err.message || "Unable to add participant");
      }
  }

  async function pickSubEventId() {
      const events = await fetchJSON(`${API_BASE}/api/events`);
      if (!Array.isArray(events) || events.length === 0) {
          alert("No events found.");
          return null;
      }

      const subEventLists = await Promise.all(
          events.map((event) => fetchJSON(`${API_BASE}/api/subevents/${event.id}`))
      );
      const subEvents = subEventLists.flat().filter(Boolean);

      if (subEvents.length === 0) {
          alert("No sub-events found.");
          return null;
      }

      const eventMap = new Map(events.map((event) => [event.id, event]));
      const listText = subEvents
          .map((subEvent) => {
              const event = eventMap.get(subEvent.eventId);
              return `${subEvent.id}: ${subEvent.name} — ${event ? event.name : "Event"}`;
          })
          .join("\n");

      const saved = localStorage.getItem("assignedSubEventId");
      const input = await showPrompt({
          title: "Select Sub-Event",
          message: `Enter Sub-Event ID:\n${listText}`,
          defaultValue: saved || subEvents[0].id
      });
      if (!input) return null;
      const id = parseInt(input, 10);
      const exists = subEvents.some((subEvent) => subEvent.id === id);
      if (!exists) {
          alert("Invalid Sub-Event ID");
          return null;
      }
      localStorage.setItem("assignedSubEventId", id);
      return id;
  }

  async function loadAssignedSubEvent() {
      const subEventId = await pickSubEventId();
      if (!subEventId) {
          labelEl.textContent = "No sub-event selected";
          setResultEditorState(null, null);
          renderStudents([]);
          stopRegistrationsAutoRefresh();
          return;
      }

      const subEvent = await fetchJSON(`${API_BASE}/api/subevents/detail/${subEventId}`);
      const events = await fetchJSON(`${API_BASE}/api/events`);
      const eventMap = new Map(events.map((event) => [event.id, event]));
      const event = eventMap.get(subEvent.eventId);

      labelEl.textContent = `${subEvent.name} — ${event ? event.name : "Event"}`;
      setResultEditorState(event || null, subEvent || null);
      await loadRegistrations(subEventId);
      startRegistrationsAutoRefresh();
  }

  showAttendanceBtn.addEventListener("click", () => setActivePanel("attendance"));
  showResultsBtn.addEventListener("click", () => setActivePanel("results"));
  saveResultsBtn.addEventListener("click", saveSubEventResults);
  offlineAddForm.addEventListener("submit", addManualParticipant);
  submitAttendanceBtn.addEventListener("click", submitAttendanceParticipants);

  setResultEditorState(null, null);
  renderStudents([]);
  document.addEventListener("DOMContentLoaded", async () => {
      document.body.style.overflow = "auto";
      setActivePanel("attendance");
      await loadAssignedSubEvent();
  });
  window.addEventListener("beforeunload", stopRegistrationsAutoRefresh);
</script>

</body>
</html>
