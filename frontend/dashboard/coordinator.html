<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coordinator Dashboard</title>

    <!-- MAIN CSS -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- GOOGLE FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <script>
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user"));

if (!token || !user) {
  window.location.href = "../index.html";
}

if (user.role !== "Coordinator") {
  alert("Access denied");
  window.location.href = "../index.html";
}
</script>

<!-- THEME TOGGLE -->
<div class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
</div>

<!-- BACKGROUND -->
<div class="bg-animation">
    <div class="floating-shapes">
        <span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span>
    </div>
</div>

<!-- MAIN CONTAINER -->
<div class="login-container">
    <div class="login-box">

        <!-- LEFT SIDE -->
        <div class="login-left" style="flex:0 0 25%;max-width:25%">
            <div class="brand-content">
                <div class="logo-icon">
                    <i class="fas fa-user-cog"></i>
                </div>

                <h1>Coordinator Panel</h1>
                <p>Manage your assigned sub-events</p>

                <div class="features-list">
                    <div class="feature-item">
                        <i class="fas fa-users"></i>
                        <span>View Participants</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-qrcode"></i>
                        <span>QR Verification</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-user-check"></i>
                        <span>Mark Attendance</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE -->
        <div class="login-right" style="flex:0 0 75%;max-width:75%">
            <div class="login-form-container" style="max-width:100%">

                <div class="form-header">
                    <h2>Assigned Sub-Event</h2>
                    <p id="assignedSubEventLabel">Loading...</p>
                </div>

                <div style="border:2px dashed var(--border-color);padding:18px;border-radius:16px;margin-bottom:20px;background:var(--input-bg)">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px">
                        <div style="font-size:1rem;color:var(--text-primary);font-weight:600">
                            Sub-event Results
                        </div>
                        <div id="resultEventStatus" style="font-size:0.82rem;color:var(--text-secondary);border:1px solid var(--border-color);padding:6px 10px;border-radius:999px">
                            Status: -
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:12px;margin-bottom:12px">
                        <div class="input-group" style="margin-bottom:0">
                            <input id="winnerInput" placeholder="Winner" />
                        </div>
                        <div class="input-group" style="margin-bottom:0">
                            <input id="runnerUpInput" placeholder="Runner-up" />
                        </div>
                        <div class="input-group" style="margin-bottom:0">
                            <input id="thirdPlaceInput" placeholder="Third Place" />
                        </div>
                    </div>

                    <p id="resultHint" style="color:var(--text-muted);font-size:0.82rem;margin:0 0 12px 0">
                        Results can be updated only when event status is Completed.
                    </p>

                    <button class="login-btn" id="saveResultsBtn" style="width:auto;padding:12px 18px">
                        <i class="fas fa-trophy"></i>
                        <span>Save Results</span>
                    </button>
                </div>

                <!-- TABLE -->
                <div style="overflow-x:auto;max-height:320px;overflow-y:auto;padding-right:6px">
                    <table style="width:100%;border-collapse:collapse;color:var(--text-primary)">
                        <thead>
                            <tr style="background:var(--input-bg)">
                                <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">Name</th>
                                <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">College</th>
                                <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">Payment</th>
                                <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">QR</th>
                                <th style="padding:12px;border:1px solid var(--border-color);color:var(--text-primary)">Attendance</th>
                            </tr>
                        </thead>
                        <tbody id="studentList"></tbody>
                    </table>
                </div>

            </div>
        </div>

    </div>
</div>

<!-- MAIN JS -->
<script src="../js/main.js"></script>

<script>
  // Allow page scroll when content exceeds viewport
  document.addEventListener("DOMContentLoaded", () => {
      document.body.style.overflow = "auto";
  });

  const labelEl = document.getElementById("assignedSubEventLabel");
  const listEl = document.getElementById("studentList");
  const statusEl = document.getElementById("resultEventStatus");
  const hintEl = document.getElementById("resultHint");
  const winnerInput = document.getElementById("winnerInput");
  const runnerUpInput = document.getElementById("runnerUpInput");
  const thirdPlaceInput = document.getElementById("thirdPlaceInput");
  const saveResultsBtn = document.getElementById("saveResultsBtn");
  let currentEvent = null;
  let currentSubEvent = null;

  async function fetchJSON(url, options = {}) {
      const res = await fetch(url, options);
      const data = await res.json();
      if (!res.ok) {
          throw new Error(data && data.message ? data.message : `Request failed (${res.status})`);
      }
      return data;
  }

  function getToken() {
      return localStorage.getItem("token");
  }

  function setResultEditorState(event, subEvent) {
      currentEvent = event || null;
      currentSubEvent = subEvent || null;
      const status = event && event.status ? event.status : "Unknown";
      statusEl.textContent = `Status: ${status}`;

      const isCompleted = status === "Completed";
      const results = subEvent && subEvent.results && typeof subEvent.results === "object" ? subEvent.results : {};

      winnerInput.value = "";
      runnerUpInput.value = "";
      thirdPlaceInput.value = "";
      winnerInput.placeholder = results.winner ? `Current: ${results.winner}` : "Winner";
      runnerUpInput.placeholder = results.runnerUp ? `Current: ${results.runnerUp}` : "Runner-up";
      thirdPlaceInput.placeholder = results.thirdPlace ? `Current: ${results.thirdPlace}` : "Third Place";

      [winnerInput, runnerUpInput, thirdPlaceInput, saveResultsBtn].forEach((el) => {
          if (!el) return;
          el.disabled = !isCompleted;
      });

      if (isCompleted) {
          hintEl.textContent = "Add or update Winner, Runner-up, and Third Place, then save.";
      } else if (status === "Unknown") {
          hintEl.textContent = "Select a sub-event to load event and result details.";
      } else {
          hintEl.textContent = "Results can be updated only when event status is Completed.";
      }
  }

  async function saveSubEventResults() {
      if (!currentSubEvent || !currentSubEvent.id) {
          alert("No sub-event selected");
          return;
      }

      const token = getToken();
      if (!token) {
          alert("Login required");
          return;
      }

      const draft = {
          winner: winnerInput.value.trim(),
          runnerUp: runnerUpInput.value.trim(),
          thirdPlace: thirdPlaceInput.value.trim()
      };

      try {
          // Refresh event + sub-event before save to avoid stale status/results checks.
          const latestSubEvent = await fetchJSON(`${API_BASE}/api/subevents/detail/${currentSubEvent.id}`);
          currentSubEvent = latestSubEvent || currentSubEvent;

          const latestEvent = await fetchJSON(`${API_BASE}/api/events/${currentSubEvent.eventId}`);
          currentEvent = latestEvent || currentEvent;
          statusEl.textContent = `Status: ${currentEvent && currentEvent.status ? currentEvent.status : "Unknown"}`;

          if (!latestEvent || latestEvent.status !== "Completed") {
              setResultEditorState(latestEvent, latestSubEvent);
              alert("Event must be Completed before updating results.");
              return;
          }

          const payload = {
              winner: draft.winner || ((latestSubEvent.results && latestSubEvent.results.winner) || ""),
              runnerUp: draft.runnerUp || ((latestSubEvent.results && latestSubEvent.results.runnerUp) || ""),
              thirdPlace: draft.thirdPlace || ((latestSubEvent.results && latestSubEvent.results.thirdPlace) || "")
          };
          if (!payload.winner && !payload.runnerUp && !payload.thirdPlace) {
              alert("Enter at least one result");
              return;
          }

          const data = await fetchJSON(`${API_BASE}/api/subevents/${currentSubEvent.id}/results`, {
              method: "PUT",
              headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify(payload)
          });
          if (data.success) {
              setResultEditorState(latestEvent, data.subEvent || latestSubEvent);
              hintEl.textContent = "Results saved. Fields are cleared for the next update.";
              alert("Results updated");
          } else {
              alert(data.message || "Failed to update results");
          }
      } catch (err) {
          console.error(err);
          alert(err.message || "Failed to update results");
      }
  }

  async function pickSubEventId() {
      const events = await fetchJSON(`${API_BASE}/api/events`);
      if (!Array.isArray(events) || events.length === 0) {
          alert("No events found.");
          return null;
      }

      const subEventLists = await Promise.all(
          events.map(e => fetchJSON(`${API_BASE}/api/subevents/${e.id}`))
      );
      const subEvents = subEventLists.flat().filter(Boolean);

      if (subEvents.length === 0) {
          alert("No sub-events found.");
          return null;
      }

      const eventMap = new Map(events.map(e => [e.id, e]));
      const listText = subEvents
          .map(se => {
              const ev = eventMap.get(se.eventId);
              const evName = ev ? ev.name : "Event";
              return `${se.id}: ${se.name} — ${evName}`;
          })
          .join("\n");

      const saved = localStorage.getItem("assignedSubEventId");
      const input = await window.uiPrompt({
          title: "Select Sub-Event",
          message: `Enter Sub-Event ID:\n${listText}`,
          defaultValue: saved || subEvents[0].id
      });
      if (!input) return null;
      const id = parseInt(input, 10);
      const exists = subEvents.some(se => se.id === id);
      if (!exists) {
          alert("Invalid Sub-Event ID");
          return null;
      }
      localStorage.setItem("assignedSubEventId", id);
      return id;
  }

  async function loadAssignedSubEvent() {
      const subEventId = await pickSubEventId();
      if (!subEventId) {
          labelEl.textContent = "No sub-event selected";
          setResultEditorState(null);
          return;
      }

      const subEvent = await fetchJSON(`${API_BASE}/api/subevents/detail/${subEventId}`);
      const events = await fetchJSON(`${API_BASE}/api/events`);
      const eventMap = new Map(events.map(e => [e.id, e]));
      const event = eventMap.get(subEvent.eventId);

      labelEl.textContent = `${subEvent.name} — ${event ? event.name : "Event"}`;
      setResultEditorState(event || null, subEvent || null);

      const registrations = await fetchJSON(`${API_BASE}/api/registrations/${subEventId}`);
      renderStudents(registrations);
  }

  function renderStudents(registrations) {
      listEl.innerHTML = "";

      if (!Array.isArray(registrations) || registrations.length === 0) {
          listEl.innerHTML = `
            <tr>
              <td colspan="5" style="padding:12px;border:1px solid var(--border-color);text-align:center;color:var(--text-muted)">
                No registrations yet
              </td>
            </tr>
          `;
          return;
      }

      registrations.forEach(r => {
          const payment = r.paymentStatus || "Pending";
          const qr = payment === "Paid" ? "Generated" : "Not Generated";
          listEl.innerHTML += `
              <tr>
                  <td style="padding:10px;border:1px solid var(--border-color)">${r.name}</td>
                  <td style="padding:10px;border:1px solid var(--border-color)">${r.college}</td>
                  <td style="padding:10px;border:1px solid var(--border-color);color:${payment === 'Paid' ? '#38a169' : '#e53e3e'}">${payment}</td>
                  <td style="padding:10px;border:1px solid var(--border-color)">${qr}</td>
                  <td style="padding:10px;border:1px solid var(--border-color);text-align:center">
                      <input type="checkbox">
                  </td>
              </tr>
          `;
      });
  }

  if (saveResultsBtn) {
      saveResultsBtn.addEventListener("click", async () => {
          await saveSubEventResults();
      });
  }

  setResultEditorState(null, null);
  document.addEventListener("DOMContentLoaded", loadAssignedSubEvent);
</script>

</body>
</html>
