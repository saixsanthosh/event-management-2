<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Management</title>

    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <script>
        const token = localStorage.getItem("token");
        const user = JSON.parse(localStorage.getItem("user"));

        if (!token || !user) {
            window.location.href = "index.html";
        }

        if (user.role !== "President") {
            alert("Access denied");
            window.location.href = "index.html";
        }

        // Allow page scroll when content exceeds viewport
        document.addEventListener("DOMContentLoaded", () => {
            document.body.style.overflow = "auto";
        });
    </script>

    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </div>

    <!-- Background -->
    <div class="bg-animation">
        <div class="floating-shapes">
            <span></span><span></span><span></span><span></span>
            <span></span><span></span><span></span><span></span>
        </div>
    </div>

    <!-- Container -->
    <div class="login-container">
        <div class="login-box">

            <!-- LEFT PANEL -->
            <div class="login-left" style="flex:0 0 25%;max-width:25%">
                <div class="brand-content">
                    <div class="logo-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h1>Event Module</h1>
                    <p>Create & manage events</p>

                    <div class="features-list">
                        <div class="feature-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Create Main Event</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-layer-group"></i>
                            <span>Add Sub Events</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-users"></i>
                            <span>Assign Roles</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-image"></i>
                            <span>Upload Poster</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT CONTENT -->
            <div class="login-right" style="flex:0 0 75%;max-width:75%">
                <div class="login-form-container" style="max-width:100%">

                    <div class="form-header">
                        <h2>Main Event Details</h2>
                        <p>Create a new event</p>
                    </div>

                    <!-- MAIN EVENT FORM -->
                    <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:20px;margin-bottom:30px">

                        <div class="input-group">
                            <div class="input-icon"><i class="fas fa-heading"></i></div>
                            <input type="text" placeholder="Main Event Name" id="eventName" style="min-height:56px;font-size:1rem;">
                        </div>

                        <div class="input-group">
                            <div class="input-icon"><i class="fas fa-calendar"></i></div>
                            <input type="date" id="eventDate" style="min-height:56px;font-size:1rem;">
                        </div>

                        <div class="input-group">
                            <div class="input-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <input type="text" placeholder="Venue" id="eventVenue" style="min-height:56px;font-size:1rem;">
                        </div>

                        <div class="input-group">
                            <div class="input-icon"><i class="fas fa-image"></i></div>
                            <input type="file" id="eventPoster" accept="image/*" style="min-height:56px;font-size:0.95rem;">
                        </div>

                    </div>

                    <div style="display:flex;gap:15px;margin-bottom:40px">
                        <button class="login-btn" style="flex:1" id="createEventBtn">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Main Event</span>
                        </button>
                        <button class="login-btn" id="deleteEventBtn" style="flex:1;background:linear-gradient(135deg,#fc8181,#f56565)">
                            <i class="fas fa-trash"></i>
                            <span>Delete Event</span>
                        </button>
                    </div>

                    <!-- SUB EVENT SECTION -->
                    <div class="form-header">
                        <h2>Sub Events</h2>
                        <p>Add activities under main event</p>
                    </div>

                    <!-- SUB EVENT CARD -->
                    <div
                        style="border:2px dashed var(--border-color);padding:25px;border-radius:16px;margin-bottom:20px">

                        <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:20px">

                            <div class="input-group">
                                <div class="input-icon"><i class="fas fa-layer-group"></i></div>
                                <input type="text" placeholder="Sub Name" id="subEventName" title="Sub Event Name" aria-label="Sub Event Name" style="padding-left:44px;padding-right:16px;min-height:56px;font-size:1rem;">
                            </div>

                            <div class="input-group">
                                <div class="input-icon"><i class="fas fa-clock"></i></div>
                                <input type="text" placeholder="Time" id="subEventTime" title="Time (e.g. 12:30 PM)" aria-label="Time" style="padding-left:44px;padding-right:16px;min-height:56px;font-size:1rem;">
                            </div>

                            <div class="input-group">
                                <div class="input-icon"><i class="fas fa-location-dot"></i></div>
                                <input type="text" placeholder="Venue" id="subEventVenue" title="Venue / Hall / Room" aria-label="Venue" style="padding-left:44px;padding-right:16px;min-height:56px;font-size:1rem;">
                            </div>

                            <div class="input-group">
                                <div class="input-icon"><i class="fas fa-user-tie"></i></div>
                                <input type="text" inputmode="numeric" placeholder="Coords" id="subEventCoordinators" title="Coordinators Required" aria-label="Coordinators Required" style="padding-left:44px;padding-right:16px;min-height:56px;font-size:1rem;">
                            </div>

                            <div class="input-group">
                                <div class="input-icon"><i class="fas fa-hands-helping"></i></div>
                                <input type="text" inputmode="numeric" placeholder="Volunteers" id="subEventVolunteers" title="Volunteers Required" aria-label="Volunteers Required" style="padding-left:44px;padding-right:16px;min-height:56px;font-size:1rem;">
                            </div>

                            <div class="input-group">
                                <div class="input-icon"><i class="fas fa-indian-rupee-sign"></i></div>
                                <input type="text" inputmode="numeric" placeholder="Fee" id="subEventFee" title="Registration Fee" aria-label="Registration Fee" style="padding-left:44px;padding-right:16px;min-height:56px;font-size:1rem;">
                            </div>

                            <div style="grid-column:1/-1">
                                <div class="segmented-control" role="radiogroup" aria-label="Participation Type">
                                    <input type="radio" id="subTypeIndividual" name="subEventParticipationType" value="Individual" checked>
                                    <label for="subTypeIndividual">Individual</label>
                                    <input type="radio" id="subTypeTeam" name="subEventParticipationType" value="Team">
                                    <label for="subTypeTeam">Team</label>
                                </div>
                            </div>

                            <div class="input-group" id="subEventTeamMinWrap" style="display:none">
                                <div class="input-icon"><i class="fas fa-users-viewfinder"></i></div>
                                <input type="text" inputmode="numeric" placeholder="Team Min" id="subEventTeamMin" title="Minimum students in team" aria-label="Minimum students in team" style="padding-left:44px;padding-right:16px;min-height:56px;font-size:1rem;">
                            </div>

                            <div class="input-group" id="subEventTeamMaxWrap" style="display:none">
                                <div class="input-icon"><i class="fas fa-users"></i></div>
                                <input type="text" inputmode="numeric" placeholder="Team Max" id="subEventTeamMax" title="Maximum students in team" aria-label="Maximum students in team" style="padding-left:44px;padding-right:16px;min-height:56px;font-size:1rem;">
                            </div>

                        </div>

                        <div style="margin-top:20px;display:flex;gap:15px">
                            <button class="login-btn" id="addSubEventBtn">
                                <i class="fas fa-plus"></i>
                                <span>Add Sub Event</span>
                            </button>

                            <button class="login-btn" id="deleteSubEventBtn" style="background:linear-gradient(135deg,#fc8181,#f56565)">
                                <i class="fas fa-trash"></i>
                                <span>Delete</span>
                            </button>
                        </div>

                    </div>

                </div>
            </div>

        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
const createEventBtn = document.getElementById("createEventBtn");
const deleteEventBtn = document.getElementById("deleteEventBtn");
const addSubEventBtn = document.getElementById("addSubEventBtn");
const deleteSubEventBtn = document.getElementById("deleteSubEventBtn");

const eventPosterInput = document.getElementById("eventPoster");
const eventNameInput = document.getElementById("eventName");
const eventDateInput = document.getElementById("eventDate");
const eventVenueInput = document.getElementById("eventVenue");

const subEventNameInput = document.getElementById("subEventName");
const subEventTimeInput = document.getElementById("subEventTime");
const subEventVenueInput = document.getElementById("subEventVenue");
const subEventCoordinatorsInput = document.getElementById("subEventCoordinators");
const subEventVolunteersInput = document.getElementById("subEventVolunteers");
const subEventFeeInput = document.getElementById("subEventFee");
const subEventTypeInputs = Array.from(document.querySelectorAll('input[name="subEventParticipationType"]'));
const subEventTeamMinWrap = document.getElementById("subEventTeamMinWrap");
const subEventTeamMaxWrap = document.getElementById("subEventTeamMaxWrap");
const subEventTeamMinInput = document.getElementById("subEventTeamMin");
const subEventTeamMaxInput = document.getElementById("subEventTeamMax");

function uiPrompt({ title, message, defaultValue = "", placeholder = "" }) {
  return new Promise((resolve) => {
    const backdrop = document.createElement("div");
    backdrop.className = "modal-backdrop";
    backdrop.innerHTML = `
      <div class="modal-card" role="dialog" aria-modal="true">
        <div class="modal-title">${title || "Input Required"}</div>
        <div class="modal-message">${message || ""}</div>
        <input class="modal-input" placeholder="${placeholder}" value="${String(defaultValue)}" />
        <div class="modal-actions">
          <button class="login-btn" data-action="cancel" type="button">Cancel</button>
          <button class="login-btn" data-action="ok" type="button">OK</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);

    const input = backdrop.querySelector(".modal-input");
    const okBtn = backdrop.querySelector('[data-action="ok"]');
    const cancelBtn = backdrop.querySelector('[data-action="cancel"]');

    const cleanup = (value) => {
      backdrop.remove();
      resolve(value);
    };

    okBtn.addEventListener("click", () => cleanup(input.value));
    cancelBtn.addEventListener("click", () => cleanup(null));
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) cleanup(null);
    });
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") cleanup(input.value);
      if (e.key === "Escape") cleanup(null);
    });

    setTimeout(() => input.focus(), 0);
  });
}

function uiConfirm({ title, message }) {
  return new Promise((resolve) => {
    const backdrop = document.createElement("div");
    backdrop.className = "modal-backdrop";
    backdrop.innerHTML = `
      <div class="modal-card" role="dialog" aria-modal="true">
        <div class="modal-title">${title || "Confirm"}</div>
        <div class="modal-message">${message || "Are you sure?"}</div>
        <div class="modal-actions">
          <button class="login-btn" data-action="cancel" type="button">Cancel</button>
          <button class="login-btn" data-action="ok" type="button">Confirm</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);

    const okBtn = backdrop.querySelector('[data-action="ok"]');
    const cancelBtn = backdrop.querySelector('[data-action="cancel"]');

    const cleanup = (value) => {
      backdrop.remove();
      resolve(value);
    };

    okBtn.addEventListener("click", () => cleanup(true));
    cancelBtn.addEventListener("click", () => cleanup(false));
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) cleanup(false);
    });
    window.addEventListener(
      "keydown",
      (e) => {
        if (e.key === "Escape") cleanup(false);
      },
      { once: true }
    );
  });
}

function getToken() {
  return localStorage.getItem("token");
}

function normalizeSubEventType(value) {
  const normalized = String(value || "").trim().toLowerCase();
  if (normalized === "team" || normalized === "teams") return "Team";
  return "Individual";
}

function getSelectedSubEventType() {
  const selected = subEventTypeInputs.find((input) => input.checked);
  return normalizeSubEventType(selected ? selected.value : "Individual");
}

function syncSubEventTypeUI() {
  const type = getSelectedSubEventType();
  const isTeam = type === "Team";
  if (subEventTeamMinWrap) subEventTeamMinWrap.style.display = isTeam ? "" : "none";
  if (subEventTeamMaxWrap) subEventTeamMaxWrap.style.display = isTeam ? "" : "none";
  if (isTeam) {
    if (!subEventTeamMinInput.value) subEventTeamMinInput.value = "2";
    if (!subEventTeamMaxInput.value) subEventTeamMaxInput.value = "4";
  } else {
    subEventTeamMinInput.value = "";
    subEventTeamMaxInput.value = "";
  }
}

async function fetchEvents() {
  const res = await fetch(`${API_BASE}/api/events`);
  return res.json();
}

async function pickEventId() {
  const events = await fetchEvents();
  if (!Array.isArray(events) || events.length === 0) {
    alert("No events found. Create a main event first.");
    return null;
  }
  const list = events.map(e => `${e.id}: ${e.name}`).join("\n");
  const defaultId = localStorage.getItem("activeEventId") || events[0].id;
  const input = await uiPrompt({
    title: "Select Event",
    message: `Enter Event ID:\n${list}`,
    defaultValue: defaultId
  });
  if (!input) return null;
  const id = parseInt(input, 10);
  const exists = events.some(e => e.id === id);
  if (!exists) {
    alert("Invalid Event ID");
    return null;
  }
  localStorage.setItem("activeEventId", id);
  return id;
}

async function createEvent() {
  const token = getToken();
  if (!token) {
    alert("Login required");
    return;
  }

  const name = eventNameInput.value.trim();
  const date = eventDateInput.value;
  const venue = eventVenueInput.value.trim();

  if (!name) {
    alert("Event name required");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/events`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        name,
        description: venue,
        date
      })
    });

    const data = await res.json();

    if (!data.success) {
      alert(data.message || "Failed to create event");
      return;
    }

    const eventId = data.event?.id;
    if (eventId) {
      localStorage.setItem("activeEventId", eventId);
    }

    if (eventPosterInput.files && eventPosterInput.files[0] && eventId) {
      await uploadPoster(eventId, eventPosterInput.files[0]);
    }

    alert("Event created successfully");
    eventNameInput.value = "";
    eventDateInput.value = "";
    eventVenueInput.value = "";
    if (eventPosterInput) eventPosterInput.value = "";
  } catch (err) {
    console.error("Fetch error:", err);
    alert("Backend not reachable");
  }
}

async function uploadPoster(eventId, file) {
  const token = getToken();
  const formData = new FormData();
  formData.append("poster", file);

  const res = await fetch(`${API_BASE}/api/events/${eventId}/poster`, {
    method: "POST",
    headers: { "Authorization": `Bearer ${token}` },
    body: formData
  });
  const data = await res.json();
  if (!data.success) {
    alert(data.message || "Poster upload failed");
  }
}

async function createSubEvent() {
  const token = getToken();
  if (!token) {
    alert("Login required");
    return;
  }

  const name = subEventNameInput.value.trim();
  const time = subEventTimeInput.value;
  const venue = subEventVenueInput.value.trim();
  const coordinatorLimit = subEventCoordinatorsInput.value;
  const volunteerLimit = subEventVolunteersInput.value;
  const fee = subEventFeeInput.value;
  const participationType = getSelectedSubEventType();

  if (!name) {
    alert("Sub-event name required");
    return;
  }
  let teamMinSize = 1;
  let teamMaxSize = 1;
  if (participationType === "Team") {
    teamMinSize = Number.parseInt(subEventTeamMinInput.value, 10);
    teamMaxSize = Number.parseInt(subEventTeamMaxInput.value, 10);
    if (!Number.isFinite(teamMinSize) || !Number.isFinite(teamMaxSize)) {
      alert("Enter valid team min and max size");
      return;
    }
    if (teamMinSize < 2 || teamMaxSize < 2 || teamMaxSize < teamMinSize) {
      alert("Team size must be valid (max should be greater than or equal to min, min 2)");
      return;
    }
  }

  const eventId = await pickEventId();
  if (!eventId) return;

  try {
    const res = await fetch(`${API_BASE}/api/subevents`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        eventId,
        name,
        coordinatorLimit: coordinatorLimit || 0,
        volunteerLimit: volunteerLimit || 0,
        fee: fee || 0,
        date: "",
        time,
        venue,
        participationType,
        teamMinSize,
        teamMaxSize
      })
    });

    const data = await res.json();
    if (!data.success) {
      alert(data.message || "Failed to create sub-event");
      return;
    }

    alert("Sub-event created successfully");
    subEventNameInput.value = "";
    subEventTimeInput.value = "";
    subEventVenueInput.value = "";
    subEventCoordinatorsInput.value = "";
    subEventVolunteersInput.value = "";
    subEventFeeInput.value = "";
    const individualInput = document.getElementById("subTypeIndividual");
    if (individualInput) individualInput.checked = true;
    syncSubEventTypeUI();
  } catch (err) {
    console.error("Fetch error:", err);
    alert("Backend not reachable");
  }
}

async function updateEvent() {
  const token = getToken();
  if (!token) {
    alert("Login required");
    return;
  }

  const events = await fetchEvents();
  if (!Array.isArray(events) || events.length === 0) {
    alert("No events found.");
    return;
  }

  const list = events.map(e => `${e.id}: ${e.name}`).join("\n");
  const input = await uiPrompt({
    title: "Update Event",
    message: `Enter Event ID to update:\n${list}`
  });
  if (!input) return;
  const id = parseInt(input, 10);
  const current = events.find(e => e.id === id);
  if (!current) {
    alert("Invalid Event ID");
    return;
  }

  const name = await uiPrompt({
    title: "Event Name",
    message: "Enter event name:",
    defaultValue: current.name
  });
  if (name === null) return;
  const date = await uiPrompt({
    title: "Event Date",
    message: "Event date (YYYY-MM-DD):",
    defaultValue: current.date || ""
  });
  if (date === null) return;
  const description = await uiPrompt({
    title: "Event Description",
    message: "Event description/venue:",
    defaultValue: current.description || ""
  });
  if (description === null) return;
  const status = await uiPrompt({
    title: "Event Status",
    message: "Status (Upcoming/Ongoing/Completed):",
    defaultValue: current.status || "Upcoming"
  });
  if (status === null) return;

  const res = await fetch(`${API_BASE}/api/events/${id}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({ name, date, description, status })
  });

  const data = await res.json();
  if (data.success) {
    alert("Event updated successfully");
  } else {
    alert(data.message || "Failed to update event");
  }
}

async function deleteEvent() {
  const token = getToken();
  if (!token) {
    alert("Login required");
    return;
  }

  const events = await fetchEvents();
  if (!Array.isArray(events) || events.length === 0) {
    alert("No events found.");
    return;
  }

  const list = events.map(e => `${e.id}: ${e.name}`).join("\n");
  const input = await uiPrompt({
    title: "Delete Event",
    message: `Enter Event ID to delete:\n${list}`
  });
  if (!input) return;
  const id = parseInt(input, 10);
  const current = events.find(e => e.id === id);
  if (!current) {
    alert("Invalid Event ID");
    return;
  }

  const confirmDelete = await uiConfirm({
    title: "Confirm Delete",
    message: `Delete event "${current.name}"?`
  });
  if (!confirmDelete) return;

  const res = await fetch(`${API_BASE}/api/events/${id}`, {
    method: "DELETE",
    headers: { "Authorization": `Bearer ${token}` }
  });
  const data = await res.json();
  if (data.success) {
    alert("Event deleted successfully");
  } else {
    alert(data.message || "Failed to delete event");
  }
}

async function updateSubEvent() {
  const token = getToken();
  if (!token) {
    alert("Login required");
    return;
  }

  const input = await uiPrompt({
    title: "Update Sub-Event",
    message: "Enter Sub-Event ID to update:"
  });
  if (!input) return;
  const id = parseInt(input, 10);

  const detailRes = await fetch(`${API_BASE}/api/subevents/detail/${id}`);
  if (!detailRes.ok) {
    alert("Sub-event not found");
    return;
  }
  const current = await detailRes.json();

  const name = await uiPrompt({
    title: "Sub-Event Name",
    message: "Sub-event name:",
    defaultValue: current.name || ""
  });
  if (name === null) return;
  const time = await uiPrompt({
    title: "Time",
    message: "Time (HH:MM):",
    defaultValue: current.time || ""
  });
  if (time === null) return;
  const venue = await uiPrompt({
    title: "Venue",
    message: "Venue:",
    defaultValue: current.venue || ""
  });
  if (venue === null) return;
  const coordinatorLimit = await uiPrompt({
    title: "Coordinators Required",
    message: "Coordinators required:",
    defaultValue: current.coordinatorLimit ?? 0
  });
  if (coordinatorLimit === null) return;
  const volunteerLimit = await uiPrompt({
    title: "Volunteers Required",
    message: "Volunteers required:",
    defaultValue: current.volunteerLimit ?? 0
  });
  if (volunteerLimit === null) return;
  const participationTypeInput = await uiPrompt({
    title: "Participation Type",
    message: "Type (Individual/Team):",
    defaultValue: current.participationType || "Individual"
  });
  if (participationTypeInput === null) return;
  const participationType = normalizeSubEventType(participationTypeInput);
  let teamMinSize = current.teamMinSize || 1;
  let teamMaxSize = current.teamMaxSize || 1;
  if (participationType === "Team") {
    const teamMinInput = await uiPrompt({
      title: "Team Min Size",
      message: "Minimum students in team:",
      defaultValue: current.teamMinSize || 2
    });
    if (teamMinInput === null) return;
    const teamMaxInput = await uiPrompt({
      title: "Team Max Size",
      message: "Maximum students in team:",
      defaultValue: current.teamMaxSize || 4
    });
    if (teamMaxInput === null) return;
    teamMinSize = Number.parseInt(teamMinInput, 10);
    teamMaxSize = Number.parseInt(teamMaxInput, 10);
    if (!Number.isFinite(teamMinSize) || !Number.isFinite(teamMaxSize) || teamMinSize < 2 || teamMaxSize < teamMinSize) {
      alert("Invalid team min/max values");
      return;
    }
  }

  const res = await fetch(`${API_BASE}/api/subevents/${id}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({
      name,
      coordinatorLimit: Number(coordinatorLimit),
      volunteerLimit: Number(volunteerLimit),
      time,
      venue,
      participationType,
      teamMinSize,
      teamMaxSize
    })
  });
  const data = await res.json();
  if (data.success) {
    alert("Sub-event updated successfully");
  } else {
    alert(data.message || "Failed to update sub-event");
  }
}

async function deleteSubEvent() {
  const token = getToken();
  if (!token) {
    alert("Login required");
    return;
  }

  const events = await fetchEvents();
  if (!Array.isArray(events) || events.length === 0) {
    alert("No events found.");
    return;
  }

  const eventList = events.map(e => `${e.id}: ${e.name}`).join("\n");
  const eventIdInput = await uiPrompt({
    title: "Select Event",
    message: `Choose event to manage sub-events:\n${eventList}`,
    defaultValue: localStorage.getItem("activeEventId") || events[0].id
  });
  if (!eventIdInput) return;
  const eventId = parseInt(eventIdInput, 10);
  const eventExists = events.some(e => e.id === eventId);
  if (!eventExists) {
    alert("Invalid Event ID");
    return;
  }

  const subRes = await fetch(`${API_BASE}/api/subevents/${eventId}`);
  const subEvents = await subRes.json();
  if (!Array.isArray(subEvents) || subEvents.length === 0) {
    alert("No sub-events found for this event.");
    return;
  }

  const subList = subEvents.map(se => `${se.id}: ${se.name}`).join("\n");
  const subIdInput = await uiPrompt({
    title: "Delete Sub-Event",
    message: `Enter Sub-Event ID to delete:\n${subList}`
  });
  if (!subIdInput) return;
  const id = parseInt(subIdInput, 10);
  const subExists = subEvents.some(se => se.id === id);
  if (!subExists) {
    alert("Invalid Sub-Event ID");
    return;
  }

  const confirmDelete = await uiConfirm({
    title: "Confirm Delete",
    message: `Delete sub-event ID ${id}?`
  });
  if (!confirmDelete) return;

  const res = await fetch(`${API_BASE}/api/subevents/${id}`, {
    method: "DELETE",
    headers: { "Authorization": `Bearer ${token}` }
  });
  const data = await res.json();
  if (data.success) {
    alert("Sub-event deleted successfully");
  } else {
    alert(data.message || "Failed to delete sub-event");
  }
}

if (createEventBtn) {
  createEventBtn.addEventListener("click", createEvent);
  createEventBtn.addEventListener("contextmenu", async (e) => {
    e.preventDefault();
    const action = await uiPrompt({
      title: "Main Event Action",
      message: "Type UPDATE or DELETE for main events:"
    });
    if (!action) return;
    if (action.toUpperCase() === "UPDATE") {
      await updateEvent();
    } else if (action.toUpperCase() === "DELETE") {
      await deleteEvent();
    } else {
      alert("Invalid action");
    }
  });
}

if (deleteEventBtn) {
  deleteEventBtn.addEventListener("click", (e) => {
    e.preventDefault();
    deleteEvent();
  });
}

if (addSubEventBtn) {
  addSubEventBtn.addEventListener("click", (e) => {
    e.preventDefault();
    createSubEvent();
  });
  addSubEventBtn.addEventListener("contextmenu", async (e) => {
    e.preventDefault();
    await updateSubEvent();
  });
}

if (deleteSubEventBtn) {
  deleteSubEventBtn.addEventListener("click", (e) => {
    e.preventDefault();
    deleteSubEvent();
  });
}

subEventTypeInputs.forEach((input) => {
  input.addEventListener("change", syncSubEventTypeUI);
});
syncSubEventTypeUI();
</script>
</body>

</html>
