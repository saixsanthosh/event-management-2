<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<title>Payment</title>

<link rel="stylesheet" href="css/style.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
.payment-box {
    border: 2px dashed var(--border-color);
    border-radius: 18px;
    padding: 25px;
    text-align: center;
    margin-bottom: 25px;
}
.status {
    padding: 10px;
    border-radius: 10px;
    font-weight: 600;
}
.pending {
    background: rgba(255,165,0,0.15);
    color: orange;
}
.success {
    background: rgba(72,187,120,0.15);
    color: var(--success-color);
}
</style>
</head>

<body>

<script>
  // Allow page scroll when content exceeds viewport
  document.addEventListener("DOMContentLoaded", () => {
      document.body.style.overflow = "auto";
  });
  </script>

  <script src="js/notify.js"></script>

<!-- THEME TOGGLE -->
<div class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
</div>

<div class="bg-animation">
    <div class="floating-shapes">
        <span></span><span></span><span></span><span></span>
    </div>
</div>

<div class="login-container">
<div class="login-box">

<div class="login-left">
    <div class="brand-content">
        <div class="logo-icon">
            <i class="fas fa-qrcode"></i>
        </div>
        <h1>Payment</h1>
        <p>Secure UPI Registration</p>
    </div>
</div>

<div class="login-right">
<div class="login-form-container">

<div class="form-header">
<h2>Complete Your Payment</h2>
<p>Scan QR & enter transaction ID</p>
</div>

<div class="payment-box">
<img id="upiQr" src="assets/qr.png.jpeg" width="180" alt="UPI QR" style="cursor:pointer">
<p style="margin-top:10px;font-weight:600">Scan & Pay</p>
</div>

<div class="input-group">
<input id="txn" placeholder="Enter Transaction ID">
</div>

<button class="login-btn" onclick="submitPayment()">
<i class="fas fa-check-circle"></i>
<span>Confirm Payment</span>
</button>

<br><br>

<div id="statusBox"></div>

</div>
</div>

</div>
</div>

<input id="qrFileInput" type="file" accept="image/*" style="display:none">

<script>
const API_ORIGIN = window.location.origin;
const qrImg = document.getElementById("upiQr");
const qrFileInput = document.getElementById("qrFileInput");

async function loadQr() {
    try {
        const res = await fetch(`${API_ORIGIN}/api/payments/qr`);
        const data = await res.json();
        if (data.success && data.qrPath) {
            qrImg.src = data.qrPath;
        }
    } catch (err) {
        console.error(err);
    }
}

function canUploadQr() {
    const user = JSON.parse(localStorage.getItem("user"));
    return user && user.role === "President";
}

qrImg.addEventListener("click", () => {
    if (!canUploadQr()) return;
    qrFileInput.click();
});

qrFileInput.addEventListener("change", async () => {
    const file = qrFileInput.files[0];
    if (!file) return;

    const token = localStorage.getItem("token");
    if (!token) {
        alert("Login required");
        return;
    }

    const formData = new FormData();
    formData.append("qr", file);

    try {
        const res = await fetch(`${API_ORIGIN}/api/payments/qr`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        });
        const data = await res.json();
        if (data.success && data.qrPath) {
            qrImg.src = data.qrPath;
            alert("UPI QR updated");
        } else {
            alert(data.message || "Upload failed");
        }
    } catch (err) {
        console.error(err);
        alert("Upload failed");
    }
});

async function submitPayment() {
    const txn = document.getElementById("txn").value;
    const statusBox = document.getElementById("statusBox");

    if (!txn) {
        alert("Enter transaction ID");
        return;
    }

    try {
        const pendingRaw = localStorage.getItem("pendingRegistration");
        if (!pendingRaw) {
            alert("Please register first before making payment.");
            return;
        }
        const pending = JSON.parse(pendingRaw);

        statusBox.innerHTML = `
            <div class="status pending">
                Processing registration...
            </div>
        `;

        const regRes = await fetch(`${API_ORIGIN}/api/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                name: pending.name,
                college: pending.college,
                department: pending.department,
                email: pending.email,
                mobile: pending.mobile,
                subEventId: pending.subEventId,
                transactionId: txn
            })
        });
        const regData = await regRes.json();
        if (!regData.success || !regData.registration) {
            alert(regData.message || "Registration failed");
            return;
        }

        localStorage.setItem("lastRegistrationId", regData.registration.id);

        const payRes = await fetch(`${API_ORIGIN}/api/payments/submit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                transactionId: txn,
                registrationId: regData.registration.id
            })
        });
        const payData = await payRes.json();

        if (payData.success) {
            localStorage.removeItem("pendingRegistration");
            localStorage.setItem("paymentSuccessMessage", "Payment submitted successfully ✔");
            statusBox.innerHTML = `
                <div class="status success">
                    Payment Submitted Successfully ✔
                </div>
            `;
            setTimeout(() => {
                window.location.href = "qr.html";
            }, 1400);
        } else {
            alert(payData.message || "Payment failed");
        }
    } catch (err) {
        console.error(err);
        alert("Backend not reachable");
    }
}

document.addEventListener("DOMContentLoaded", loadQr);
</script>

<script src="js/main.js"></script>

</body>
</html>
