<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>Payment</title>

<link rel="stylesheet" href="css/style.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
.payment-box {
    border: 2px dashed var(--border-color);
    border-radius: 18px;
    padding: 25px;
    text-align: center;
    margin-bottom: 25px;
}
.status {
    padding: 10px;
    border-radius: 10px;
    font-weight: 600;
}
.pending {
    background: rgba(255,165,0,0.15);
    color: orange;
}
.success {
    background: rgba(72,187,120,0.15);
    color: var(--success-color);
}
</style>
</head>

<body>

<script>
  // Allow page scroll when content exceeds viewport
  document.addEventListener("DOMContentLoaded", () => {
      document.body.style.overflow = "auto";
  });
</script>

<script src="js/notify.js"></script>

<!-- THEME TOGGLE -->
<div class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
</div>

<div class="bg-animation">
    <div class="floating-shapes">
        <span></span><span></span><span></span><span></span>
    </div>
</div>

<div class="login-container">
<div class="login-box">

<div class="login-left">
    <div class="brand-content">
        <div class="logo-icon">
            <i class="fas fa-credit-card"></i>
        </div>
        <h1>Payment</h1>
        <p>Secure Razorpay Checkout</p>
    </div>
</div>

<div class="login-right">
<div class="login-form-container">

<div class="form-header">
<h2>Complete Your Payment</h2>
<p>Proceed using Razorpay and confirm instantly</p>
</div>

<div class="payment-box">
<div style="font-size:2rem;color:var(--accent-color);margin-bottom:8px">
    <i class="fas fa-bolt"></i>
</div>
<p style="margin:0 0 6px 0;font-weight:600">Pay securely with Razorpay</p>
<p id="feeLabel" style="margin:0;color:var(--text-secondary)">Fee: Loading...</p>
</div>

<button id="payBtn" class="login-btn">
<i class="fas fa-lock"></i>
<span>Pay With Razorpay</span>
</button>

<br><br>

<div id="statusBox"></div>

</div>
</div>

</div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
const API_ORIGIN = window.location.origin;
const statusBox = document.getElementById("statusBox");
const feeLabel = document.getElementById("feeLabel");
const payBtn = document.getElementById("payBtn");
const REG_CACHE_KEY = "pendingRegistrationIds";

let pendingRegistration = null;
let selectedSubEvent = null;
let processing = false;

function setStatus(type, message) {
    statusBox.innerHTML = `<div class="status ${type}">${message}</div>`;
}

function parseJSON(raw) {
    try {
        return JSON.parse(raw);
    } catch (_) {
        return null;
    }
}

function getPendingFingerprint(pending) {
    if (!pending || !pending.subEventId) return "";
    if (pending.participationType === "Team") {
        const members = Array.isArray(pending.members) ? pending.members : [];
        const emails = members
            .map((member) => String(member && member.email || "").trim().toLowerCase())
            .filter(Boolean)
            .sort()
            .join("|");
        const teamName = String(pending.teamName || "").trim().toLowerCase();
        return `team:${pending.subEventId}:${teamName}:${emails}`;
    }
    return `single:${pending.subEventId}:${String(pending.email || "").trim().toLowerCase()}`;
}

function readCachedRegistrationIds(fingerprint) {
    const cached = parseJSON(localStorage.getItem(REG_CACHE_KEY));
    if (!cached || cached.fingerprint !== fingerprint || !Array.isArray(cached.registrationIds)) {
        return [];
    }
    return cached.registrationIds
        .map((id) => Number.parseInt(id, 10))
        .filter((id) => Number.isFinite(id));
}

function writeCachedRegistrationIds(fingerprint, ids) {
    localStorage.setItem(REG_CACHE_KEY, JSON.stringify({
        fingerprint,
        registrationIds: ids
    }));
}

async function fetchJSON(url, options = {}) {
    const res = await fetch(url, options);
    const data = await res.json();
    if (!res.ok) {
        throw new Error((data && data.message) || `Request failed (${res.status})`);
    }
    if (data && typeof data === "object" && Object.prototype.hasOwnProperty.call(data, "success") && !data.success) {
        throw new Error(data.message || "Request failed");
    }
    return data;
}

async function loadSubEvent() {
    if (!pendingRegistration || !pendingRegistration.subEventId) return;
    try {
        const subEvent = await fetchJSON(`${API_ORIGIN}/api/subevents/detail/${pendingRegistration.subEventId}`);
        selectedSubEvent = subEvent;
        const fee = Number(subEvent.fee);
        if (Number.isFinite(fee)) {
            feeLabel.textContent = `Fee: INR ${fee.toLocaleString("en-IN")}`;
        } else {
            feeLabel.textContent = "Fee: INR --";
        }
    } catch (err) {
        feeLabel.textContent = "Fee: Unable to load";
        console.error(err);
    }
}

async function registerIfNeeded() {
    const fingerprint = getPendingFingerprint(pendingRegistration);
    const cachedIds = readCachedRegistrationIds(fingerprint);
    if (cachedIds.length > 0) {
        return cachedIds;
    }

    const payload = pendingRegistration && pendingRegistration.participationType === "Team"
        ? {
            subEventId: pendingRegistration.subEventId,
            teamName: pendingRegistration.teamName || "",
            members: Array.isArray(pendingRegistration.members) ? pendingRegistration.members : []
        }
        : {
            name: pendingRegistration.name,
            college: pendingRegistration.college,
            department: pendingRegistration.department,
            email: pendingRegistration.email,
            mobile: pendingRegistration.mobile,
            subEventId: pendingRegistration.subEventId
        };

    const regData = await fetchJSON(`${API_ORIGIN}/api/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });
    const ids = regData.registration
        ? [regData.registration.id]
        : (Array.isArray(regData.registrations) ? regData.registrations.map((item) => item.id) : []);
    if (!Array.isArray(ids) || ids.length === 0) {
        throw new Error("Registration not created");
    }
    localStorage.setItem("lastRegistrationId", ids[0]);
    writeCachedRegistrationIds(fingerprint, ids);
    return ids;
}

async function createRazorpayOrder(registrationIds) {
    return fetchJSON(`${API_ORIGIN}/api/payments/create-order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ registrationIds })
    });
}

async function verifyRazorpayPayment(payload) {
    return fetchJSON(`${API_ORIGIN}/api/payments/verify`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });
}

function onPaymentSuccess() {
    localStorage.removeItem("pendingRegistration");
    localStorage.removeItem(REG_CACHE_KEY);
    localStorage.setItem("paymentSuccessMessage", "Payment completed successfully ✔");
    setStatus("success", "Payment completed successfully ✔");
    setTimeout(() => {
        window.location.href = "qr.html";
    }, 1200);
}

function openCheckout(orderPayload, pending) {
    const options = {
        key: orderPayload.keyId,
        amount: orderPayload.order.amount,
        currency: orderPayload.order.currency,
        name: "College Event Management",
        description: selectedSubEvent && selectedSubEvent.name
            ? `${selectedSubEvent.name} Registration`
            : "Event Registration Fee",
        order_id: orderPayload.order.id,
        handler: async function (response) {
            try {
                setStatus("pending", "Verifying payment...");
                await verifyRazorpayPayment({
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature
                });
                onPaymentSuccess();
            } catch (err) {
                setStatus("pending", err.message || "Payment verification failed.");
                alert(err.message || "Payment verification failed");
            }
        },
        modal: {
            ondismiss: function () {
                setStatus("pending", "Payment not completed. You can retry.");
            }
        },
        prefill: pending.participationType === "Team"
            ? {}
            : {
                name: pending.name || "",
                email: pending.email || "",
                contact: pending.mobile || ""
            },
        theme: { color: "#667eea" }
    };

    const rz = new Razorpay(options);
    rz.on("payment.failed", function (response) {
        const message = response && response.error && response.error.description
            ? response.error.description
            : "Payment failed";
        setStatus("pending", message);
        alert(message);
    });
    rz.open();
}

async function startPayment() {
    if (processing) return;
    if (!pendingRegistration) {
        alert("Please register first before making payment.");
        window.location.href = "student.html";
        return;
    }
    if (typeof window.Razorpay !== "function") {
        alert("Razorpay script failed to load. Check internet and retry.");
        return;
    }

    processing = true;
    payBtn.disabled = true;
    try {
        setStatus("pending", "Preparing registration...");
        const registrationIds = await registerIfNeeded();
        setStatus("pending", "Creating payment order...");
        const orderPayload = await createRazorpayOrder(registrationIds);
        setStatus("pending", "Opening Razorpay checkout...");
        openCheckout(orderPayload, pendingRegistration);
    } catch (err) {
        console.error(err);
        setStatus("pending", err.message || "Unable to start payment");
        alert(err.message || "Unable to start payment");
    } finally {
        processing = false;
        payBtn.disabled = false;
    }
}

document.addEventListener("DOMContentLoaded", async () => {
    pendingRegistration = parseJSON(localStorage.getItem("pendingRegistration"));
    if (!pendingRegistration) {
        setStatus("pending", "No pending registration found. Please register again.");
        payBtn.disabled = true;
        return;
    }
    await loadSubEvent();
});

payBtn.addEventListener("click", startPayment);
</script>

<script src="js/main.js"></script>

</body>
</html>
